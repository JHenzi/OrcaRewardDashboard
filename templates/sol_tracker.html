<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SOL Price Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- TradingView Lightweight Charts - Professional Trading Chart Library -->
    <!-- Using v4.x for compatibility (v5.x has breaking API changes) -->
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        /* Professional Trading Chart Styles */
        #tradingview-chart {
            width: 100%;
            height: 500px;
            background: #1a1a1a;
            border-radius: 8px;
            position: relative;
        }
        #rsi-chart {
            width: 100%;
            height: 150px;
            background: #1a1a1a;
            border-radius: 8px;
            margin-top: 10px;
        }
        .chart-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .signal-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        .signal-buy { background: #10b981; }
        .signal-sell { background: #ef4444; }
        .signal-hold { background: #f59e0b; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto p-6">
        <h1 class="text-5xl font-bold mb-4 text-center text-white">SOL Price Tracker</h1>
        
        <!-- Info Notice: Focus on Trading Signals -->
        <div class="mb-4 bg-blue-900 border-l-4 border-blue-500 text-blue-200 p-4 rounded">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium">
                <strong>ğŸ“Š Intelligent Price Analysis:</strong> This page focuses on trading signals (buy/sell/hold) from our contextual bandit algorithm. Price prediction has been disabled, but we're actively working on improvements including technical indicators, signal performance analysis, and enhanced charting. See <code>SOL_TRACKER_IMPROVEMENT_PLAN.md</code> for details.
              </p>
            </div>
          </div>
        </div>

        <!-- DEPRECATED: Price Prediction Display (Commented Out) -->
        {# Price prediction has been disabled - keeping this section commented for reference
        <div class="mb-8 bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-xl shadow-xl p-8">
          {% if predictions and predictions|length > 0 %}
            {% set p = predictions[0] %}
            <div class="grid grid-cols-2 gap-6 text-center items-center opacity-75">
              <div>
                <div class="text-4xl font-extrabold mb-2">Predicted Price <span class="text-xs">(Historical)</span></div>
                <div class="text-5xl font-extrabold flex justify-center items-center space-x-4">
                  <span>{{ '$' ~ (p.predicted | round(2)) }}</span>
                  {% if p.error < 0.5 %}
                    <span class="text-green-300">âœ…</span>
                  {% elif p.actual > p.predicted %}
                    <span class="text-green-300 animate-bounce">â¬†ï¸</span>
                  {% elif p.actual < p.predicted %}
                    <span class="text-red-400 animate-pulse">â¬‡ï¸</span>
                  {% else %}
                    <span class="text-yellow-300">â¸ï¸</span>
                  {% endif %}
                </div>
              </div>
              <div>
                <div class="text-4xl font-extrabold mb-2">Actual Price</div>
                <div class="text-5xl font-extrabold">
                  <span class="inline-block px-4 py-2 bg-white bg-opacity-20 rounded">{{ '$' ~ (p.actual | round(2)) }}</span>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
        #}

        <!-- Active: Latest Trading Signal Display -->
        <div class="mb-8 bg-gradient-to-r from-gray-800 to-gray-700 text-white rounded-xl shadow-xl p-8 border border-gray-600">
          {% if bandit_logs and bandit_logs|length > 0 %}
            {% set b = bandit_logs[0] %}
            <div class="text-center">
              <div class="text-4xl font-extrabold mb-4">Current Trading Signal</div>
              <div class="text-6xl font-extrabold flex justify-center items-center space-x-4 mb-4">
                {% if b.action == 'buy' %}
                  <span class="text-green-300">Buy ğŸŸ¢</span>
                {% elif b.action == 'sell' %}
                  <span class="text-red-300">Sell ğŸ”´</span>
                {% else %}
                  <span class="text-yellow-300">Hold ğŸŸ¡</span>
                {% endif %}
              </div>
              <div class="text-lg opacity-90 mt-4">
                <div class="grid grid-cols-4 gap-4 text-center">
                  <div>
                    <div class="text-sm opacity-70">Reward</div>
                    <div class="text-xl font-bold">{{ "%.4f"|format(b.reward) }}</div>
                  </div>
                  <div>
                    <div class="text-sm opacity-70">Buy Score</div>
                    <div class="text-xl font-bold">{{ "%.4f"|format(b.prediction_buy) if b.prediction_buy is not none else 'N/A' }}</div>
                  </div>
                  <div>
                    <div class="text-sm opacity-70">Sell Score</div>
                    <div class="text-xl font-bold">{{ "%.4f"|format(b.prediction_sell) if b.prediction_sell is not none else 'N/A' }}</div>
                  </div>
                  <div>
                    <div class="text-sm opacity-70">Hold Score</div>
                    <div class="text-xl font-bold">{{ "%.4f"|format(b.prediction_hold) if b.prediction_hold is not none else 'N/A' }}</div>
                  </div>
                </div>
              </div>
              <div class="text-sm opacity-70 italic mt-4">
                Last updated: {{ b.timestamp }}
              </div>
            </div>
          {% else %}
            <div class="text-xl font-semibold text-center">No trading signals available yet</div>
          {% endif %}
        </div>
        <!-- Range Selector -->
      <div class="flex justify-end items-center mb-4">
        <form method="get" action="/sol-tracker" class="flex items-center space-x-2">
          <label for="range" class="text-sm font-medium text-gray-700">ğŸ•’ Time Range:</label>
          <select id="range" name="range" onchange="this.form.submit()" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-3 py-1.5 shadow-sm">
            <option value="hour" {% if selected_range == 'hour' %}selected{% endif %}>1 Hour</option>
            <option value="day" {% if selected_range == 'day' %}selected{% endif %}>1 Day</option>
            <option value="week" {% if selected_range == 'week' %}selected{% endif %}>1 Week</option>
            <option value="month" {% if selected_range == 'month' %}selected{% endif %}>1 Month</option>
            <option value="year" {% if selected_range == 'year' %}selected{% endif %}>1 Year</option>
          </select>
        </form>
      </div>


        <!-- Professional Trading Chart -->
        <div class="chart-container">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">SOL/USD Price Chart</h2>
                <div class="text-sm text-gray-400">
                    <span id="chart-price" class="text-2xl font-bold text-green-400">$0.00</span>
                    <span id="chart-change" class="ml-2"></span>
                </div>
            </div>
            <div id="tradingview-chart"></div>
            <div id="rsi-chart"></div>
        </div>
        <div class="mt-8 bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-white">ğŸ“Š {{ selected_range|capitalize }} Price Summary</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm text-gray-200">

              <div><strong>ğŸ’° Current Price:</strong> ${{ stats.current_price if stats.current_price is not none else 'N/A' }}</div>
              <div><strong>ğŸ“… Start of Period:</strong> ${{ stats.price_start if stats.price_start is not none else 'N/A' }}</div>

              <div>
                <strong>ğŸ“ˆ % Change ({{ selected_range|capitalize }}):</strong>
                <span class="{% if stats.percent_change is not none and stats.percent_change > 0 %}text-green-600{% elif stats.percent_change is not none and stats.percent_change < 0 %}text-red-600{% else %}text-gray-500{% endif %}">
                  {{ stats.percent_change if stats.percent_change is not none else '0' }}%
                  {% if stats.percent_change is not none and stats.percent_change > 0 %}â¬†ï¸{% elif stats.percent_change is not none and stats.percent_change < 0 %}â¬‡ï¸{% else %}â¸ï¸{% endif %}
                </span>
              </div>

              <div><strong>ğŸ“ˆ High ({{ selected_range|capitalize }}):</strong> ${{ stats.high if stats.high is not none else 'N/A' }}</div>
              <div><strong>ğŸ“‰ Low ({{ selected_range|capitalize }}):</strong> ${{ stats.low if stats.low is not none else 'N/A' }}</div>
              <div><strong>ğŸ“Š Range ({{ selected_range|capitalize }}):</strong> ${{ stats.range if stats.range is not none else 'N/A' }}</div>

              {# SMAs are calculated based on number of data points, might not always align with selected_range #}
              {# Keeping existing SMA labels as they describe the window of the moving average itself #}
              <div><strong>ğŸ• SMA (1h):</strong> ${{ stats.sma_1h if stats.sma_1h is not none else 'N/A' }}</div>
              <div><strong>ğŸ•“ SMA (4h):</strong> ${{ stats.sma_4h if stats.sma_4h is not none else 'N/A' }}</div>
              <div><strong>ğŸ•› SMA (24h):</strong> ${{ stats.sma_24h if stats.sma_24h is not none else 'N/A' }}</div>

              <div>
                <strong>ğŸ“Š RSI (14):</strong>
                {% if stats.rsi is not none %}
                  <span class="{% if stats.rsi > 70 %}text-red-600 font-semibold{% elif stats.rsi < 30 %}text-green-600 font-semibold{% else %}text-gray-700{% endif %}">
                    {{ "%.2f"|format(stats.rsi) }}
                    {% if stats.rsi > 70 %} (Overbought âš ï¸){% elif stats.rsi < 30 %} (Oversold ğŸ“ˆ){% else %} (Neutral){% endif %}
                  </span>
                {% else %}
                  <span class="text-gray-500">N/A</span>
                {% endif %}
              </div>

              <div>
                <strong>ğŸ¯ Std Dev:</strong>
                <span class="{% if stats.std_dev is not none and stats.std_dev > 2 %}text-red-500 font-semibold{% elif stats.std_dev is not none and stats.std_dev > 1 %}text-yellow-500{% else %}text-green-600{% endif %}">
                  ${{ stats.std_dev if stats.std_dev is not none else 'N/A' }}
                  {% if stats.std_dev is not none and stats.std_dev > 2 %}âš ï¸{% elif stats.std_dev is not none and stats.std_dev > 1 %}ğŸ“‰{% else %}ğŸ‘Œ{% endif %}
                </span>
              </div>

              <div><strong>ğŸ“‰ Avg Î” / 5min:</strong> ${{ stats.avg_delta if stats.avg_delta is not none else 'N/A' }}</div>
            </div>
          </div>




          <!-- DEPRECATED: Recent Price Predictions (Commented Out) -->
          {# Price prediction has been disabled - keeping this section commented for reference
          <div x-data="{ showAll: false }" class="mt-8 bg-white p-6 rounded-lg shadow-lg border-2 border-yellow-300">
            <h2 class="text-xl font-semibold mb-2">ğŸ§  Recent Predictions <span class="text-sm text-yellow-600 font-normal">(Deprecated - Historical Data Only)</span></h2>
            <p class="text-sm text-gray-600 mb-4 italic">Price prediction has been disabled. The data below is historical and no new predictions are being generated.</p>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm text-left text-gray-700 border">
                <thead class="bg-gray-100 text-xs uppercase font-semibold text-gray-600">
                  <tr>
                    <th class="px-4 py-2 border-b">â±ï¸ Timestamp</th>
                    <th class="px-4 py-2 border-b">ğŸ”® Predicted</th>
                    <th class="px-4 py-2 border-b">âœ… Actual</th>
                    <th class="px-4 py-2 border-b">ğŸ“‰ Error</th>
                    <th class="px-4 py-2 border-b relative group">
                      ğŸ“Š MAE
                      <span class="ml-1 text-gray-400 cursor-help">?</span>
                      <div class="absolute z-10 hidden group-hover:block bg-white text-xs text-gray-800 border rounded shadow-md p-2 w-64 top-full left-1/2 transform -translate-x-1/2 mt-1">
                        Mean Absolute Error (MAE) is the average difference between the predicted and actual SOL price. Lower is better.
                      </div>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in predictions %}
                  <template x-if="showAll || {{ loop.index }} <= 5">
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-2 border-b">{{ p.timestamp }}</td>
                      <td class="px-4 py-2 border-b">${{ p.predicted }}</td>
                      <td class="px-4 py-2 border-b">${{ p.actual }}</td>
                      <td class="px-4 py-2 border-b text-red-600">${{ p.error }}</td>
                      <td class="px-4 py-2 border-b text-blue-600">${{ p.mae }}</td>
                    </tr>
                  </template>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="mt-4 text-center">
              <button @click="showAll = !showAll" class="text-sm text-blue-600 hover:underline focus:outline-none">
                <span x-text="showAll ? 'Show Less' : 'Show All'"></span>
              </button>
            </div>
          </div>
          #}

          <!-- Bandit Strategy State -->
          <div class="mt-8 bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-white">ğŸ“¡ Bandit Strategy State</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <table class="w-full text-sm text-left text-gray-700 border border-gray-200 rounded-lg overflow-hidden shadow">
                  <thead class="bg-indigo-100 text-gray-800 text-xs uppercase font-semibold">
                    <tr>
                      <th colspan="2" class="px-4 py-2 text-center">âš™ï¸ Strategy Info</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="border-t">
                      <td class="px-4 py-2 font-medium">ğŸ§  Last Action</td>
                      <td class="px-4 py-2">{{ bandit_state.last_action | capitalize }}</td>
                    </tr>
                    <tr class="border-t">
                      <td class="px-4 py-2 font-medium">ğŸ’µ Entry Price</td>
                      <td class="px-4 py-2">${{ "%.2f" | format(bandit_state.portfolio.entry_price | float) }}</td>
                    </tr>
                    <tr class="border-t">
                      <td class="px-4 py-2 font-medium">ğŸ“ Position Open</td>
                      <td class="px-4 py-2">{{ "Yes âœ…" if bandit_state.position_open else "No âŒ" }}</td>
                    </tr>
                    <tr class="border-t">
                      <td class="px-4 py-2 font-medium">ğŸ“‰ Fee</td>
                      <td class="px-4 py-2">{{ "%.2f" | format(bandit_state.fee) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div>
                <table class="w-full text-sm text-left text-gray-700 border border-gray-200 rounded-lg overflow-hidden shadow">
                  <thead class="bg-indigo-100 text-gray-800 text-xs uppercase font-semibold">
                    <tr>
                      <th colspan="2" class="px-4 py-2 text-center">ğŸ’¼ Portfolio</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="border-t">
                      <td class="px-4 py-2 font-medium">ğŸª™ SOL Balance</td>
                      <td class="px-4 py-2">{{ "%2.f" | format(bandit_state.portfolio.sol_balance) }}</td>
                    </tr>
                    <tr class="border-t">
                      <td class="px-4 py-2 font-medium">ğŸ’° USD Balance</td>
                      <td class="px-4 py-2">${{ "%.2f" | format(bandit_state.portfolio.usd_balance) }}</td>
                    </tr>
                    <tr class="border-t">
                      <td class="px-4 py-2 font-medium">ğŸ§¾ Cost Basis</td>
                      <td class="px-4 py-2">${{ "%.2f" | format(bandit_state.portfolio.total_cost_basis) }}
                        {% if bandit_state.portfolio.sol_balance > 0 %}
                          (${{ "%.2f"|format(bandit_state.portfolio.total_cost_basis / bandit_state.portfolio.sol_balance) }})
                        {% endif %}</td>
                    </tr>
                    <tr class="border-t">
                      <td class="px-4 py-2 font-medium">ğŸ“ˆ Realized PnL</td>
                      <td class="px-4 py-2 text-green-600">${{ "%.2f" | format(bandit_state.portfolio.realized_pnl) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        <!-- Bandit Model Summary -->
        <div class="mt-8 bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
          <h2 class="text-xl font-semibold mb-4 text-white">ğŸ¤– Bandit Model Summary</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <table class="w-full text-sm text-left text-gray-700 border border-gray-200 rounded-lg overflow-hidden shadow">
                <thead class="bg-indigo-200 text-gray-800 text-xs uppercase font-semibold border-b border-indigo-300">
                  <tr>
                    <th colspan="2" class="px-4 py-2 text-center">âš™ï¸ Strategy Info</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="border-t">
                    <td class="px-4 py-3 font-medium text-gray-600">ğŸ“‹ Logged Actions</td>
                    <td class="px-4 py-3 text-right font-mono text-gray-900">{{ bandit_stats.num_rows }}</td>
                  </tr>
                  <tr class="border-t">
                    <td class="px-4 py-3 font-medium text-gray-600">ğŸ¯ Average Reward</td>
                    <td class="px-4 py-3 text-right font-mono text-gray-900">{{ "%.4f"|format(bandit_stats.avg_reward) }}</td>
                  </tr>
                  <tr class="border-t">
                    <td class="px-4 py-3 font-medium text-gray-600">ğŸ“Š Reward Std Dev</td>
                    <td class="px-4 py-3 text-right font-mono text-gray-900">{{ "%.4f"|format(bandit_stats.std_reward) }}</td>
                  </tr>
                  <tr class="border-t">
                    <td class="px-4 py-3 font-medium text-gray-600">âŒ Average Regret</td>
                    <td class="px-4 py-3 text-right font-mono text-gray-900">{{ "%.4f"|format(bandit_stats.avg_regret) }}</td>
                  </tr>
                </tbody>
              </table>
              <!--<table class="w-full mt-6 text-sm text-left text-gray-700 border border-gray-200 rounded-lg overflow-hidden shadow">
                <thead class="bg-indigo-100 text-gray-800 text-xs uppercase font-semibold">
                  <tr>
                    <th colspan="2" class="px-4 py-2 text-center">ğŸ† Top 5 Rewards</th>
                  </tr>
                </thead>
                <tbody>
                  {% for trade in bandit_stats.top_rewards %}
                  <tr class="border-t">
                    <td class="px-4 py-2">{{ trade.timestamp }}</td>
                    <td class="px-4 py-2">{{ trade.action }}: {{ trade.reward }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>-->
            </div>

            <div>
              <table class="w-full text-sm text-left text-gray-700 border border-gray-200 rounded-lg overflow-hidden shadow">
                <thead class="bg-indigo-100 text-gray-800 text-xs uppercase font-semibold">
                  <tr>
                    <th colspan="2" class="px-4 py-2 text-center">ğŸ“Š Action Counts</th>
                  </tr>
                </thead>
                <tbody>
                  {% for action, count in bandit_stats.action_counts.items() %}
                  <tr class="border-t">
                    <td class="px-4 py-2 font-medium">{{ action }}</td>
                    <td class="px-4 py-2">{{ count }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>

              <table class="w-full mt-6 text-sm text-left text-gray-700 border border-gray-200 rounded-lg overflow-hidden shadow">
                <thead class="bg-indigo-100 text-gray-800 text-xs uppercase font-semibold">
                  <tr>
                    <th colspan="2" class="px-4 py-2 text-center">ğŸ“ˆ Avg Reward by Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for action, reward in bandit_stats.avg_reward_by_action.items() %}
                  <tr class="border-t">
                    <td class="px-4 py-2 font-medium">{{ action }}</td>
                    <td class="px-4 py-2">{{ reward }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
        </div>


          <!-- Contextual Bandit Logs -->
          <div x-data="{ showAllLogs: false }" class="mt-8 bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-white">ğŸ¤– Contextual Bandit Logs</h2>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm text-left text-gray-700 border">
                <thead class="bg-gray-100 text-xs uppercase font-semibold text-gray-600">
                  <tr>
                    <th class="px-4 py-2 border-b">â±ï¸ Timestamp</th>
                    <th class="px-4 py-2 border-b">ğŸ¯ Action</th>
                    <th class="px-4 py-2 border-b">ğŸ Reward</th>
                    <th class="px-4 py-2 border-b">ğŸ”® Buy Prediction</th>
                    <th class="px-4 py-2 border-b">ğŸ”® Sell Prediction</th>
                    <th class="px-4 py-2 border-b">ğŸ”® Hold Prediction</th>
                  </tr>
                </thead>
                <tbody>
                  {% for log in bandit_logs %}
                  <template x-if="showAllLogs || {{ loop.index }} <= 5">
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-2 border-b">{{ log.timestamp }}</td>
                      <td class="px-4 py-2 border-b font-semibold text-indigo-700">{{ log.action | capitalize }}</td>
                      <td class="px-4 py-2 border-b">{{ log.reward }}</td>
                      <td class="px-4 py-2 border-b">{{ log.prediction_buy if log.prediction_buy is not none else 'N/A' }}</td>
                      <td class="px-4 py-2 border-b">{{ log.prediction_sell if log.prediction_sell is not none else 'N/A' }}</td>
                      <td class="px-4 py-2 border-b">{{ log.prediction_hold if log.prediction_hold is not none else 'N/A' }}</td>
                    </tr>
                  </template>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="mt-4 text-center">
              <button @click="showAllLogs = !showAllLogs" class="text-sm text-blue-600 hover:underline focus:outline-none">
                <span x-text="showAllLogs ? 'Show Less' : 'Show All'"></span>
              </button>
            </div>
          </div>

    </div>


    <script>
      // Wait for TradingView library to load
      function initChart() {
      // Data from Flask
      const timestamps = {{ timestamps|tojson }};
      const prices = {{ prices|tojson }};
      const banditLogs = {{ bandit_logs|tojson }};
      const rsiValues = {{ rsi_values|tojson }};
      const unixTimestamps = {{ unix_timestamps|tojson }};

      // Debug: Log data to console
      console.log('Timestamps:', timestamps ? timestamps.length : 0);
      console.log('Prices:', prices ? prices.length : 0);
      console.log('Unix Timestamps:', unixTimestamps ? unixTimestamps.length : 0);
      console.log('Unix Timestamps type:', typeof unixTimestamps);
      console.log('Unix Timestamps value:', unixTimestamps);
      if (timestamps && timestamps.length > 0) {
          console.log('Sample data:', {
              firstTimestamp: timestamps[0],
              firstPrice: prices[0],
              firstUnix: unixTimestamps && unixTimestamps.length > 0 ? unixTimestamps[0] : 'undefined'
          });
      }

      // Prepare price data for TradingView (using Unix timestamps from server)
      const priceData = [];
      const timestampToIndex = {};
      
      if (timestamps.length !== prices.length || timestamps.length !== unixTimestamps.length) {
          console.error('Data length mismatch!', {
              timestamps: timestamps.length,
              prices: prices.length,
              unixTimestamps: unixTimestamps.length
          });
      }
      
      // Check if we have valid data
      if (!unixTimestamps || unixTimestamps.length === 0) {
          console.warn('WARNING: unixTimestamps is empty! Generating from formatted timestamps as fallback.');
          // Fallback: Generate Unix timestamps from formatted timestamps
          // This is less ideal but will work if server-side generation failed
          unixTimestamps = [];
          timestamps.forEach((ts, i) => {
              try {
                  // Parse "Nov 26, 06:38 PM" format
                  const date = new Date(ts);
                  if (!isNaN(date.getTime())) {
                      unixTimestamps.push(Math.floor(date.getTime() / 1000));
                  } else {
                      // If parsing fails, use current time as fallback (not ideal but prevents crash)
                      console.warn(`Failed to parse timestamp: ${ts}, using current time`);
                      unixTimestamps.push(Math.floor(Date.now() / 1000));
                  }
              } catch (e) {
                  console.error(`Error parsing timestamp ${ts}:`, e);
                  unixTimestamps.push(Math.floor(Date.now() / 1000));
              }
          });
          console.log('Generated', unixTimestamps.length, 'Unix timestamps as fallback');
      }
      
      if (timestamps && prices && unixTimestamps) {
          timestamps.forEach((ts, i) => {
              const unixTime = unixTimestamps[i];
              const price = prices[i];
              
              if (unixTime && price !== undefined && !isNaN(price) && price > 0) {
                  priceData.push({
                      time: unixTime,
                      value: price
                  });
                  timestampToIndex[ts] = i;
              }
          });
      } else {
          console.error('Missing required data arrays:', {
              hasTimestamps: !!timestamps,
              hasPrices: !!prices,
              hasUnixTimestamps: !!unixTimestamps
          });
      }

      console.log('Price data prepared:', priceData.length, 'points');
      if (priceData.length > 0) {
          console.log('First price point:', priceData[0]);
          console.log('Last price point:', priceData[priceData.length - 1]);
      }

      // Create signal markers
      const buyMarkers = [];
      const sellMarkers = [];
      const holdMarkers = [];

      banditLogs.forEach(log => {
          const ts = log.timestamp;
          const index = timestampToIndex[ts];
          if (index !== undefined && prices[index] !== undefined && unixTimestamps[index]) {
              const unixTime = unixTimestamps[index];
              const marker = {
                  time: unixTime,
                  position: 'belowBar',
                  color: log.action === 'buy' ? '#10b981' : log.action === 'sell' ? '#ef4444' : '#f59e0b',
                  shape: log.action === 'buy' ? 'arrowUp' : log.action === 'sell' ? 'arrowDown' : 'circle',
                  text: log.action.toUpperCase(),
                  size: 1
              };
              
              if (log.action === 'buy') buyMarkers.push(marker);
              else if (log.action === 'sell') sellMarkers.push(marker);
              else holdMarkers.push(marker);
          }
      });

      // Prepare RSI data
      const rsiData = [];
      if (rsiValues && unixTimestamps) {
          rsiValues.forEach((rsi, index) => {
              if (rsi !== null && rsi !== undefined && index < timestamps.length && unixTimestamps[index]) {
                  rsiData.push({
                      time: unixTimestamps[index],
                      value: rsi
                  });
              }
          });
      }
      
      console.log('RSI data prepared:', rsiData.length, 'points');

      // Professional Dark Theme Configuration
      const chartOptions = {
          layout: {
              background: { color: '#1a1a1a' },
              textColor: '#d1d5db',
          },
          grid: {
              vertLines: { color: '#2a2a2a', style: 1 },
              horzLines: { color: '#2a2a2a', style: 1 },
          },
          crosshair: {
              mode: 1,
              vertLine: {
                  color: '#6b7280',
                  width: 1,
                  style: 3,
              },
              horzLine: {
                  color: '#6b7280',
                  width: 1,
                  style: 3,
              },
          },
          rightPriceScale: {
              borderColor: '#2a2a2a',
              scaleMargins: {
                  top: 0.1,
                  bottom: 0.1,
              },
          },
          timeScale: {
              borderColor: '#2a2a2a',
              timeVisible: true,
              secondsVisible: false,
          },
      };

      // Create main price chart
      const chartContainer = document.getElementById('tradingview-chart');
      
      if (!chartContainer) {
          console.error('Chart container not found!');
      } else if (typeof LightweightCharts === 'undefined') {
          console.error('TradingView Lightweight Charts library not loaded!');
          chartContainer.innerHTML = '<div class="text-white p-4 text-center">Chart library failed to load. Please refresh the page.</div>';
      } else if (priceData.length === 0) {
          console.error('No price data available!');
          console.error('Debug info:', {
              timestampsLength: timestamps ? timestamps.length : 0,
              pricesLength: prices ? prices.length : 0,
              unixTimestampsLength: unixTimestamps ? unixTimestamps.length : 0,
              unixTimestampsType: typeof unixTimestamps,
              unixTimestampsValue: unixTimestamps
          });
          chartContainer.innerHTML = '<div class="text-white p-4 text-center">No price data available for the selected time range. Check console for details.</div>';
      } else {
          let chart, priceSeries, rsiChart, rsiSeries;
          
          try {
              console.log('Creating chart with', priceData.length, 'data points');
              console.log('LightweightCharts object:', typeof LightweightCharts, LightweightCharts);
              
              // Check if createChart exists
              if (!LightweightCharts || !LightweightCharts.createChart) {
                  throw new Error('LightweightCharts.createChart is not available. Library may not have loaded correctly.');
              }
              
              chart = LightweightCharts.createChart(chartContainer, {
                  ...chartOptions,
                  width: chartContainer.clientWidth,
                  height: 500,
              });

              console.log('Chart created:', chart);
              console.log('Chart methods:', Object.keys(chart).filter(k => k.includes('Series')));
              
              // Check if addLineSeries exists, if not try addSeries (v5.x API)
              if (typeof chart.addLineSeries === 'function') {
                  // v4.x API
                  priceSeries = chart.addLineSeries({
                      color: '#3b82f6',
                      lineWidth: 2,
                      priceFormat: {
                          type: 'price',
                          precision: 2,
                          minMove: 0.01,
                      },
                      lastValueVisible: true,
                      priceLineVisible: true,
                  });
              } else if (typeof chart.addSeries === 'function' && LightweightCharts.LineSeries) {
                  // v5.x API
                  priceSeries = chart.addSeries(LightweightCharts.LineSeries, {
                      color: '#3b82f6',
                      lineWidth: 2,
                      priceFormat: {
                          type: 'price',
                          precision: 2,
                          minMove: 0.01,
                      },
                      lastValueVisible: true,
                      priceLineVisible: true,
                  });
              } else {
                  throw new Error('Neither addLineSeries nor addSeries(LineSeries) is available. Chart library version issue.');
              }

              // Set price data
              if (priceData.length > 0) {
                  priceSeries.setData(priceData);
                  console.log('Price data set successfully');

                  // Add markers for buy/sell/hold signals
                  const allMarkers = [...buyMarkers, ...sellMarkers, ...holdMarkers];
                  if (allMarkers.length > 0) {
                      priceSeries.setMarkers(allMarkers);
                      console.log('Markers set:', allMarkers.length);
                  }
              } else {
                  console.error('No price data to display!');
                  // Show error message
                  chartContainer.innerHTML = '<div class="text-white p-4 text-center">No price data available for the selected time range.</div>';
              }

              // Update price display on crosshair move
              chart.subscribeCrosshairMove(param => {
                  if (param.point === undefined || !param.time || param.seriesData.size === 0) {
                      return;
                  }
                  const price = param.seriesData.get(priceSeries);
                  if (price) {
                      const currentPrice = price.value;
                      const firstPrice = prices[0];
                      const change = currentPrice - firstPrice;
                      const changePercent = ((change / firstPrice) * 100).toFixed(2);
                      
                      document.getElementById('chart-price').textContent = `$${currentPrice.toFixed(2)}`;
                      const changeEl = document.getElementById('chart-change');
                      changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent}%)`;
                      changeEl.className = change >= 0 ? 'ml-2 text-green-400' : 'ml-2 text-red-400';
                  }
              });

              // Create RSI chart below
              const rsiChartContainer = document.getElementById('rsi-chart');
              if (rsiChartContainer) {
                  rsiChart = LightweightCharts.createChart(rsiChartContainer, {
                  ...chartOptions,
                  height: 150,
                  rightPriceScale: {
                      ...chartOptions.rightPriceScale,
                      visible: true,
                      scaleMargins: {
                          top: 0.1,
                          bottom: 0.1,
                      },
                  },
              });

                  // Check API version for RSI series
                  if (typeof rsiChart.addLineSeries === 'function') {
                      // v4.x API
                      rsiSeries = rsiChart.addLineSeries({
                          color: '#d97706',
                          lineWidth: 1,
                          priceFormat: {
                              type: 'price',
                              precision: 2,
                              minMove: 0.01,
                          },
                      });
                  } else if (typeof rsiChart.addSeries === 'function' && LightweightCharts.LineSeries) {
                      // v5.x API
                      rsiSeries = rsiChart.addSeries(LightweightCharts.LineSeries, {
                          color: '#d97706',
                          lineWidth: 1,
                          priceFormat: {
                              type: 'price',
                              precision: 2,
                              minMove: 0.01,
                          },
                      });
                  } else {
                      console.error('Cannot create RSI series - API not available');
                      rsiSeries = null;
                  }
                  
                  if (rsiSeries && rsiData.length > 0) {
                      rsiSeries.setData(rsiData);

                      // Add RSI overbought/oversold lines
                      rsiSeries.createPriceLine({
                          price: 70,
                          color: '#ef4444',
                          lineWidth: 1,
                          lineStyle: 2,
                          axisLabelVisible: true,
                          title: 'Overbought',
                      });

                      rsiSeries.createPriceLine({
                          price: 30,
                          color: '#10b981',
                          lineWidth: 1,
                          lineStyle: 2,
                          axisLabelVisible: true,
                          title: 'Oversold',
                      });
                  } else {
                      console.warn('No RSI data available');
                  }

                  // Synchronize crosshair between charts
                  if (chart && rsiChart && rsiSeries) {
                      chart.subscribeCrosshairMove(param => {
                          if (param.time && rsiChart) {
                              rsiChart.setCrosshairPosition(param.time, param.point);
                          }
                      });

                      rsiChart.subscribeCrosshairMove(param => {
                          if (param.time && chart) {
                              chart.setCrosshairPosition(param.time, param.point);
                          }
                      });

                      // Handle window resize
                      window.addEventListener('resize', () => {
                          if (chart) chart.applyOptions({ width: chartContainer.clientWidth });
                          if (rsiChart) rsiChart.applyOptions({ width: rsiChartContainer.clientWidth });
                      });
                  }
              } // Close rsiChartContainer if block
          } catch (error) {
              console.error('Error creating chart:', error);
              chartContainer.innerHTML = '<div class="text-white p-4 text-center">Error creating chart: ' + error.message + '</div>';
          }
      } // Close else block (priceData.length > 0)

      // Set initial price display
      if (prices && prices.length > 0) {
          const lastPrice = prices[prices.length - 1];
          const firstPrice = prices[0];
          const change = lastPrice - firstPrice;
          const changePercent = firstPrice > 0 ? ((change / firstPrice) * 100).toFixed(2) : '0.00';
          
          const priceEl = document.getElementById('chart-price');
          const changeEl = document.getElementById('chart-change');
          
          if (priceEl) {
              priceEl.textContent = `$${lastPrice.toFixed(2)}`;
          }
          
          if (changeEl) {
              changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent}%)`;
              changeEl.className = change >= 0 ? 'ml-2 text-green-400' : 'ml-2 text-red-400';
          }
      } else {
          console.warn('No prices available for display');
          const priceEl = document.getElementById('chart-price');
          if (priceEl) {
              priceEl.textContent = 'No Data';
          }
      } // End initChart function
      
      // Wait for library to load, then initialize chart
      if (typeof LightweightCharts !== 'undefined') {
          initChart();
      } else {
          // Wait for library to load
          window.addEventListener('load', function() {
              if (typeof LightweightCharts !== 'undefined') {
                  initChart();
              } else {
                  console.error('TradingView Lightweight Charts failed to load');
                  const chartContainer = document.getElementById('tradingview-chart');
                  if (chartContainer) {
                      chartContainer.innerHTML = '<div class="text-white p-4 text-center">Chart library failed to load. Please refresh the page.</div>';
                  }
              }
          });
      }
  </script>
</body>
</html>
