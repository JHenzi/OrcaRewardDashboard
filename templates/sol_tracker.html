<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SOL Price Tracker - RSI Trading Signals</title>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- TradingView Lightweight Charts - Professional Trading Chart Library -->
    <!-- Using v4.x for compatibility (v5.x has breaking API changes) -->
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        /* Professional Trading Chart Styles */
        #tradingview-chart {
            width: 100%;
            height: 500px;
            background: #1a1a1a;
            border-radius: 8px;
            position: relative;
        }
        #rsi-chart {
            width: 100%;
            height: 150px;
            background: #1a1a1a;
            border-radius: 8px;
            margin-top: 10px;
        }
        .chart-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .signal-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        .signal-buy { background: #10b981; }
        .signal-sell { background: #ef4444; }
        .signal-hold { background: #f59e0b; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Navigation Header -->
    <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="/" class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-blue-500 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üêã</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-white">Orca Tracker</h1>
                            <p class="text-xs text-gray-400">Solana Rewards & Trading</p>
                        </div>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition text-sm font-medium">
                        Home
                    </a>
                    <a href="/orca" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition text-sm font-medium">
                        Rewards
                    </a>
                    <a href="/sol-tracker" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 rounded-lg transition text-sm font-medium">
                        SOL Tracker
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <!-- Modern Header Section -->
        <div class="mb-8 fade-in">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">SOL Price Tracker</h1>
                    <p class="text-gray-400">Professional trading charts with technical indicators</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <form method="get" action="/sol-tracker" class="flex items-center space-x-2">
                        <label for="range" class="text-sm font-medium text-gray-300">Time Range:</label>
                        <select id="range" name="range" onchange="this.form.submit()" class="bg-gray-700 border border-gray-600 text-gray-100 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2 shadow-sm hover:bg-gray-600 transition">
                            <option value="hour" {% if selected_range == 'hour' %}selected{% endif %}>1 Hour</option>
                            <option value="day" {% if selected_range == 'day' %}selected{% endif %}>1 Day</option>
                            <option value="week" {% if selected_range == 'week' %}selected{% endif %}>1 Week</option>
                            <option value="month" {% if selected_range == 'month' %}selected{% endif %}>1 Month</option>
                            <option value="year" {% if selected_range == 'year' %}selected{% endif %}>1 Year</option>
                        </select>
                    </form>
                </div>
            </div>
            
            <!-- Key Metrics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <!-- Current Price -->
                <div class="bg-gradient-to-br from-purple-600 to-blue-600 rounded-xl p-4 shadow-lg">
                    <div class="text-sm text-purple-200 mb-1">Current Price</div>
                    <div class="text-2xl font-bold text-white">${{ "%.2f"|format(stats.current_price) if stats.current_price is not none else 'N/A' }}</div>
                </div>
                
                <!-- RSI Signal -->
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 hover:border-purple-500 transition">
                    <div class="text-sm text-gray-400 mb-1">RSI (14)</div>
                    {% if stats.rsi is not none %}
                        {% if stats.rsi > 70 %}
                            <div class="text-2xl font-bold text-red-400">{{ "%.1f"|format(stats.rsi) }}</div>
                            <div class="text-xs text-red-300 mt-1">Overbought</div>
                        {% elif stats.rsi < 30 %}
                            <div class="text-2xl font-bold text-green-400">{{ "%.1f"|format(stats.rsi) }}</div>
                            <div class="text-xs text-green-300 mt-1">Oversold</div>
                        {% else %}
                            <div class="text-2xl font-bold text-gray-300">{{ "%.1f"|format(stats.rsi) }}</div>
                            <div class="text-xs text-gray-400 mt-1">Neutral</div>
                        {% endif %}
                    {% else %}
                        <div class="text-2xl font-bold text-gray-500">N/A</div>
                    {% endif %}
                </div>
                
                <!-- Price Change -->
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 hover:border-blue-500 transition">
                    <div class="text-sm text-gray-400 mb-1">24h Change</div>
                    {% if stats.percent_change is not none %}
                        <div class="text-2xl font-bold {% if stats.percent_change > 0 %}text-green-400{% elif stats.percent_change < 0 %}text-red-400{% else %}text-gray-300{% endif %}">
                            {{ "%.2f"|format(stats.percent_change) }}%
                        </div>
                    {% else %}
                        <div class="text-2xl font-bold text-gray-500">N/A</div>
                    {% endif %}
                </div>
                
                <!-- High/Low Range -->
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 hover:border-green-500 transition">
                    <div class="text-sm text-gray-400 mb-1">Range</div>
                    {% if stats.high is not none and stats.low is not none %}
                        <div class="text-lg font-bold text-white">${{ "%.2f"|format(stats.high) }}</div>
                        <div class="text-xs text-gray-400">High / ${{ "%.2f"|format(stats.low) }} Low</div>
                    {% else %}
                        <div class="text-2xl font-bold text-gray-500">N/A</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- DEPRECATED: Price Prediction Display (Commented Out) -->
        {# Price prediction has been disabled - keeping this section commented for reference
        <div class="mb-8 bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-xl shadow-xl p-8">
          {% if predictions and predictions|length > 0 %}
            {% set p = predictions[0] %}
            <div class="grid grid-cols-2 gap-6 text-center items-center opacity-75">
              <div>
                <div class="text-4xl font-extrabold mb-2">Predicted Price <span class="text-xs">(Historical)</span></div>
                <div class="text-5xl font-extrabold flex justify-center items-center space-x-4">
                  <span>{{ '$' ~ (p.predicted | round(2)) }}</span>
                  {% if p.error < 0.5 %}
                    <span class="text-green-300">‚úÖ</span>
                  {% elif p.actual > p.predicted %}
                    <span class="text-green-300 animate-bounce">‚¨ÜÔ∏è</span>
                  {% elif p.actual < p.predicted %}
                    <span class="text-red-400 animate-pulse">‚¨áÔ∏è</span>
                  {% else %}
                    <span class="text-yellow-300">‚è∏Ô∏è</span>
                  {% endif %}
                </div>
              </div>
              <div>
                <div class="text-4xl font-extrabold mb-2">Actual Price</div>
                <div class="text-5xl font-extrabold">
                  <span class="inline-block px-4 py-2 bg-white bg-opacity-20 rounded">{{ '$' ~ (p.actual | round(2)) }}</span>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
        #}

        <!-- RSI-Based Trading Signal -->
        <div class="mb-8 fade-in">
          {% if stats.rsi is not none %}
            {% if stats.rsi < 30 %}
              <!-- BUY Signal - RSI Oversold -->
              <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl shadow-2xl p-8 border-2 border-green-400 animate-pulse">
                <div class="text-center">
                  <div class="text-5xl font-extrabold mb-4 flex items-center justify-center space-x-4">
                    <span>üü¢ BUY SIGNAL</span>
                  </div>
                  <div class="text-2xl mb-4 opacity-90">RSI indicates oversold conditions</div>
                  <div class="grid grid-cols-3 gap-6 mt-6">
                    <div class="bg-white/10 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">RSI Value</div>
                      <div class="text-3xl font-bold">{{ "%.1f"|format(stats.rsi) }}</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">Current Price</div>
                      <div class="text-3xl font-bold">${{ "%.2f"|format(stats.current_price) if stats.current_price is not none else 'N/A' }}</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">Signal Strength</div>
                      <div class="text-3xl font-bold">Strong</div>
                    </div>
                  </div>
                  <div class="mt-6 text-sm opacity-75 italic">
                    RSI below 30 suggests potential buying opportunity. Consider entering long positions.
                  </div>
                </div>
              </div>
            {% elif stats.rsi > 70 %}
              <!-- SELL Signal - RSI Overbought -->
              <div class="bg-gradient-to-r from-red-600 to-pink-600 text-white rounded-xl shadow-2xl p-8 border-2 border-red-400 animate-pulse">
                <div class="text-center">
                  <div class="text-5xl font-extrabold mb-4 flex items-center justify-center space-x-4">
                    <span>üî¥ SELL SIGNAL</span>
                  </div>
                  <div class="text-2xl mb-4 opacity-90">RSI indicates overbought conditions</div>
                  <div class="grid grid-cols-3 gap-6 mt-6">
                    <div class="bg-white/10 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">RSI Value</div>
                      <div class="text-3xl font-bold">{{ "%.1f"|format(stats.rsi) }}</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">Current Price</div>
                      <div class="text-3xl font-bold">${{ "%.2f"|format(stats.current_price) if stats.current_price is not none else 'N/A' }}</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">Signal Strength</div>
                      <div class="text-3xl font-bold">Strong</div>
                    </div>
                  </div>
                  <div class="mt-6 text-sm opacity-75 italic">
                    RSI above 70 suggests potential selling opportunity. Consider taking profits or entering short positions.
                  </div>
                </div>
              </div>
            {% else %}
              <!-- HOLD Signal - RSI Neutral -->
              <div class="bg-gradient-to-r from-gray-700 to-gray-800 text-white rounded-xl shadow-xl p-8 border border-gray-600">
                <div class="text-center">
                  <div class="text-5xl font-extrabold mb-4 flex items-center justify-center space-x-4">
                    <span>üü° HOLD SIGNAL</span>
                  </div>
                  <div class="text-2xl mb-4 opacity-90">RSI indicates neutral conditions</div>
                  <div class="grid grid-cols-3 gap-6 mt-6">
                    <div class="bg-gray-600/30 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">RSI Value</div>
                      <div class="text-3xl font-bold">{{ "%.1f"|format(stats.rsi) }}</div>
                    </div>
                    <div class="bg-gray-600/30 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">Current Price</div>
                      <div class="text-3xl font-bold">${{ "%.2f"|format(stats.current_price) if stats.current_price is not none else 'N/A' }}</div>
                    </div>
                    <div class="bg-gray-600/30 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">Signal Strength</div>
                      <div class="text-3xl font-bold">Neutral</div>
                    </div>
                  </div>
                  <div class="mt-6 text-sm opacity-75 italic">
                    RSI between 30-70 suggests neutral market conditions. Wait for clearer signals before taking action.
                  </div>
                </div>
              </div>
            {% endif %}
          {% else %}
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-8 text-center">
              <div class="text-xl font-semibold text-gray-400">Insufficient data for RSI calculation</div>
              <div class="text-sm text-gray-500 mt-2">Need at least 15 price points to calculate RSI</div>
            </div>
          {% endif %}
        </div>


        <!-- Professional Trading Chart -->
        <div class="chart-container">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">SOL/USD Price Chart</h2>
                <div class="text-sm text-gray-400">
                    <span id="chart-price" class="text-2xl font-bold text-green-400">$0.00</span>
                    <span id="chart-change" class="ml-2"></span>
                </div>
            </div>
            <div id="tradingview-chart"></div>
            <div id="rsi-chart"></div>
        </div>
        <div class="mt-8 bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-white">üìä {{ selected_range|capitalize }} Price Summary</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm text-gray-200">

              <div><strong>üí∞ Current Price:</strong> ${{ stats.current_price if stats.current_price is not none else 'N/A' }}</div>
              <div><strong>üìÖ Start of Period:</strong> ${{ stats.price_start if stats.price_start is not none else 'N/A' }}</div>

              <div>
                <strong>üìà % Change ({{ selected_range|capitalize }}):</strong>
                <span class="{% if stats.percent_change is not none and stats.percent_change > 0 %}text-green-600{% elif stats.percent_change is not none and stats.percent_change < 0 %}text-red-600{% else %}text-gray-500{% endif %}">
                  {{ stats.percent_change if stats.percent_change is not none else '0' }}%
                  {% if stats.percent_change is not none and stats.percent_change > 0 %}‚¨ÜÔ∏è{% elif stats.percent_change is not none and stats.percent_change < 0 %}‚¨áÔ∏è{% else %}‚è∏Ô∏è{% endif %}
                </span>
              </div>

              <div><strong>üìà High ({{ selected_range|capitalize }}):</strong> ${{ stats.high if stats.high is not none else 'N/A' }}</div>
              <div><strong>üìâ Low ({{ selected_range|capitalize }}):</strong> ${{ stats.low if stats.low is not none else 'N/A' }}</div>
              <div><strong>üìä Range ({{ selected_range|capitalize }}):</strong> ${{ stats.range if stats.range is not none else 'N/A' }}</div>

              {# SMAs are calculated based on number of data points, might not always align with selected_range #}
              {# Keeping existing SMA labels as they describe the window of the moving average itself #}
              <div><strong>üïê SMA (1h):</strong> ${{ stats.sma_1h if stats.sma_1h is not none else 'N/A' }}</div>
              <div><strong>üïì SMA (4h):</strong> ${{ stats.sma_4h if stats.sma_4h is not none else 'N/A' }}</div>
              <div><strong>üïõ SMA (24h):</strong> ${{ stats.sma_24h if stats.sma_24h is not none else 'N/A' }}</div>

              <div>
                <strong>üìä RSI (14):</strong>
                {% if stats.rsi is not none %}
                  <span class="{% if stats.rsi > 70 %}text-red-400 font-semibold{% elif stats.rsi < 30 %}text-green-400 font-semibold{% else %}text-gray-300{% endif %}">
                    {{ "%.2f"|format(stats.rsi) }}
                    {% if stats.rsi > 70 %} (Overbought ‚ö†Ô∏è){% elif stats.rsi < 30 %} (Oversold üìà){% else %} (Neutral){% endif %}
                  </span>
                {% else %}
                  <span class="text-gray-500">N/A</span>
                {% endif %}
              </div>

              <div>
                <strong>üéØ Std Dev:</strong>
                <span class="{% if stats.std_dev is not none and stats.std_dev > 2 %}text-red-500 font-semibold{% elif stats.std_dev is not none and stats.std_dev > 1 %}text-yellow-500{% else %}text-green-600{% endif %}">
                  ${{ stats.std_dev if stats.std_dev is not none else 'N/A' }}
                  {% if stats.std_dev is not none and stats.std_dev > 2 %}‚ö†Ô∏è{% elif stats.std_dev is not none and stats.std_dev > 1 %}üìâ{% else %}üëå{% endif %}
                </span>
              </div>

              <div><strong>üìâ Avg Œî / 5min:</strong> ${{ stats.avg_delta if stats.avg_delta is not none else 'N/A' }}</div>
            </div>
          </div>




          <!-- DEPRECATED: Recent Price Predictions (Commented Out) -->
          {# Price prediction has been disabled - keeping this section commented for reference
          <div x-data="{ showAll: false }" class="mt-8 bg-white p-6 rounded-lg shadow-lg border-2 border-yellow-300">
            <h2 class="text-xl font-semibold mb-2">üß† Recent Predictions <span class="text-sm text-yellow-600 font-normal">(Deprecated - Historical Data Only)</span></h2>
            <p class="text-sm text-gray-600 mb-4 italic">Price prediction has been disabled. The data below is historical and no new predictions are being generated.</p>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm text-left text-gray-700 border">
                <thead class="bg-gray-100 text-xs uppercase font-semibold text-gray-600">
                  <tr>
                    <th class="px-4 py-2 border-b">‚è±Ô∏è Timestamp</th>
                    <th class="px-4 py-2 border-b">üîÆ Predicted</th>
                    <th class="px-4 py-2 border-b">‚úÖ Actual</th>
                    <th class="px-4 py-2 border-b">üìâ Error</th>
                    <th class="px-4 py-2 border-b relative group">
                      üìä MAE
                      <span class="ml-1 text-gray-400 cursor-help">?</span>
                      <div class="absolute z-10 hidden group-hover:block bg-white text-xs text-gray-800 border rounded shadow-md p-2 w-64 top-full left-1/2 transform -translate-x-1/2 mt-1">
                        Mean Absolute Error (MAE) is the average difference between the predicted and actual SOL price. Lower is better.
                      </div>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in predictions %}
                  <template x-if="showAll || {{ loop.index }} <= 5">
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-2 border-b">{{ p.timestamp }}</td>
                      <td class="px-4 py-2 border-b">${{ p.predicted }}</td>
                      <td class="px-4 py-2 border-b">${{ p.actual }}</td>
                      <td class="px-4 py-2 border-b text-red-600">${{ p.error }}</td>
                      <td class="px-4 py-2 border-b text-blue-600">${{ p.mae }}</td>
                    </tr>
                  </template>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="mt-4 text-center">
              <button @click="showAll = !showAll" class="text-sm text-blue-600 hover:underline focus:outline-none">
                <span x-text="showAll ? 'Show Less' : 'Show All'"></span>
              </button>
            </div>
          </div>
          #}

          <!-- Technical Indicators Summary -->
          <div class="mt-8 bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 fade-in">
            <h2 class="text-xl font-semibold mb-6 text-white">üìä Technical Indicators Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Moving Averages -->
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                <h3 class="text-sm font-semibold text-gray-300 mb-3 uppercase tracking-wide">Moving Averages</h3>
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span class="text-gray-400">SMA (1h)</span>
                    <span class="text-white font-semibold">${{ stats.sma_1h if stats.sma_1h is not none else 'N/A' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">SMA (4h)</span>
                    <span class="text-white font-semibold">${{ stats.sma_4h if stats.sma_4h is not none else 'N/A' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">SMA (24h)</span>
                    <span class="text-white font-semibold">${{ stats.sma_24h if stats.sma_24h is not none else 'N/A' }}</span>
                  </div>
                </div>
              </div>
              
              <!-- RSI Details -->
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                <h3 class="text-sm font-semibold text-gray-300 mb-3 uppercase tracking-wide">RSI Analysis</h3>
                <div class="space-y-2">
                  {% if stats.rsi is not none %}
                    <div class="flex justify-between">
                      <span class="text-gray-400">RSI (14)</span>
                      <span class="{% if stats.rsi > 70 %}text-red-400{% elif stats.rsi < 30 %}text-green-400{% else %}text-gray-300{% endif %} font-semibold">
                        {{ "%.2f"|format(stats.rsi) }}
                      </span>
                    </div>
                    <div class="mt-3">
                      {% if stats.rsi > 70 %}
                        <div class="text-xs text-red-300 bg-red-900/30 px-2 py-1 rounded">Overbought Zone</div>
                      {% elif stats.rsi < 30 %}
                        <div class="text-xs text-green-300 bg-green-900/30 px-2 py-1 rounded">Oversold Zone</div>
                      {% else %}
                        <div class="text-xs text-gray-400 bg-gray-600/30 px-2 py-1 rounded">Neutral Zone</div>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="text-gray-500">Insufficient data</div>
                  {% endif %}
                </div>
              </div>
              
              <!-- Volatility -->
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                <h3 class="text-sm font-semibold text-gray-300 mb-3 uppercase tracking-wide">Volatility</h3>
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span class="text-gray-400">Std Dev</span>
                    <span class="{% if stats.std_dev is not none and stats.std_dev > 2 %}text-red-400{% elif stats.std_dev is not none and stats.std_dev > 1 %}text-yellow-400{% else %}text-green-400{% endif %} font-semibold">
                      ${{ stats.std_dev if stats.std_dev is not none else 'N/A' }}
                    </span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">Avg Œî / 5min</span>
                    <span class="text-white font-semibold">${{ stats.avg_delta if stats.avg_delta is not none else 'N/A' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

    </div>


    <script>
      // Wait for TradingView library to load
      function initChart() {
      // Data from Flask
      const timestamps = {{ timestamps|tojson }};
      const prices = {{ prices|tojson }};
      const rsiValues = {{ rsi_values|tojson }};
      const unixTimestamps = {{ unix_timestamps|tojson }};

      // Debug: Log data to console
      console.log('Timestamps:', timestamps ? timestamps.length : 0);
      console.log('Prices:', prices ? prices.length : 0);
      console.log('Unix Timestamps:', unixTimestamps ? unixTimestamps.length : 0);
      console.log('Unix Timestamps type:', typeof unixTimestamps);
      console.log('Unix Timestamps value:', unixTimestamps);
      if (timestamps && timestamps.length > 0) {
          console.log('Sample data:', {
              firstTimestamp: timestamps[0],
              firstPrice: prices[0],
              firstUnix: unixTimestamps && unixTimestamps.length > 0 ? unixTimestamps[0] : 'undefined'
          });
      }

      // Prepare price data for TradingView (using Unix timestamps from server)
      const priceData = [];
      const timestampToIndex = {};
      
      if (timestamps.length !== prices.length || timestamps.length !== unixTimestamps.length) {
          console.error('Data length mismatch!', {
              timestamps: timestamps.length,
              prices: prices.length,
              unixTimestamps: unixTimestamps.length
          });
      }
      
      // Check if we have valid data
      if (!unixTimestamps || unixTimestamps.length === 0) {
          console.warn('WARNING: unixTimestamps is empty! Generating from formatted timestamps as fallback.');
          // Fallback: Generate Unix timestamps from formatted timestamps
          // This is less ideal but will work if server-side generation failed
          unixTimestamps = [];
          timestamps.forEach((ts, i) => {
              try {
                  // Parse "Nov 26, 06:38 PM" format
                  const date = new Date(ts);
                  if (!isNaN(date.getTime())) {
                      unixTimestamps.push(Math.floor(date.getTime() / 1000));
                  } else {
                      // If parsing fails, use current time as fallback (not ideal but prevents crash)
                      console.warn(`Failed to parse timestamp: ${ts}, using current time`);
                      unixTimestamps.push(Math.floor(Date.now() / 1000));
                  }
              } catch (e) {
                  console.error(`Error parsing timestamp ${ts}:`, e);
                  unixTimestamps.push(Math.floor(Date.now() / 1000));
              }
          });
          console.log('Generated', unixTimestamps.length, 'Unix timestamps as fallback');
      }
      
      if (timestamps && prices && unixTimestamps) {
          timestamps.forEach((ts, i) => {
              const unixTime = unixTimestamps[i];
              const price = prices[i];
              
              if (unixTime && price !== undefined && !isNaN(price) && price > 0) {
                  priceData.push({
                      time: unixTime,
                      value: price
                  });
                  timestampToIndex[ts] = i;
              }
          });
      } else {
          console.error('Missing required data arrays:', {
              hasTimestamps: !!timestamps,
              hasPrices: !!prices,
              hasUnixTimestamps: !!unixTimestamps
          });
      }

      console.log('Price data prepared:', priceData.length, 'points');
      if (priceData.length > 0) {
          console.log('First price point:', priceData[0]);
          console.log('Last price point:', priceData[priceData.length - 1]);
      }

      // Create RSI-based signal markers
      const buyMarkers = [];
      const sellMarkers = [];
      
      // Add markers based on RSI values (oversold = buy, overbought = sell)
      if (rsiValues && unixTimestamps && prices) {
          rsiValues.forEach((rsi, index) => {
              if (rsi !== null && rsi !== undefined && index < unixTimestamps.length && unixTimestamps[index]) {
                  const unixTime = unixTimestamps[index];
                  
                  // Buy signal: RSI < 30 (oversold)
                  if (rsi < 30) {
                      buyMarkers.push({
                          time: unixTime,
                          position: 'belowBar',
                          color: '#10b981',
                          shape: 'arrowUp',
                          text: 'BUY',
                          size: 1
                      });
                  }
                  // Sell signal: RSI > 70 (overbought)
                  else if (rsi > 70) {
                      sellMarkers.push({
                          time: unixTime,
                          position: 'aboveBar',
                          color: '#ef4444',
                          shape: 'arrowDown',
                          text: 'SELL',
                          size: 1
                      });
                  }
              }
          });
      }

      // Prepare RSI data
      const rsiData = [];
      if (rsiValues && unixTimestamps) {
          rsiValues.forEach((rsi, index) => {
              if (rsi !== null && rsi !== undefined && index < timestamps.length && unixTimestamps[index]) {
                  rsiData.push({
                      time: unixTimestamps[index],
                      value: rsi
                  });
              }
          });
      }
      
      console.log('RSI data prepared:', rsiData.length, 'points');

      // Professional Dark Theme Configuration
      const chartOptions = {
          layout: {
              background: { color: '#1a1a1a' },
              textColor: '#d1d5db',
          },
          grid: {
              vertLines: { color: '#2a2a2a', style: 1 },
              horzLines: { color: '#2a2a2a', style: 1 },
          },
          crosshair: {
              mode: 1,
              vertLine: {
                  color: '#6b7280',
                  width: 1,
                  style: 3,
              },
              horzLine: {
                  color: '#6b7280',
                  width: 1,
                  style: 3,
              },
          },
          rightPriceScale: {
              borderColor: '#2a2a2a',
              scaleMargins: {
                  top: 0.1,
                  bottom: 0.1,
              },
          },
          timeScale: {
              borderColor: '#2a2a2a',
              timeVisible: true,
              secondsVisible: false,
          },
      };

      // Create main price chart
      const chartContainer = document.getElementById('tradingview-chart');
      
      if (!chartContainer) {
          console.error('Chart container not found!');
      } else if (typeof LightweightCharts === 'undefined') {
          console.error('TradingView Lightweight Charts library not loaded!');
          chartContainer.innerHTML = '<div class="text-white p-4 text-center">Chart library failed to load. Please refresh the page.</div>';
      } else if (priceData.length === 0) {
          console.error('No price data available!');
          console.error('Debug info:', {
              timestampsLength: timestamps ? timestamps.length : 0,
              pricesLength: prices ? prices.length : 0,
              unixTimestampsLength: unixTimestamps ? unixTimestamps.length : 0,
              unixTimestampsType: typeof unixTimestamps,
              unixTimestampsValue: unixTimestamps
          });
          chartContainer.innerHTML = '<div class="text-white p-4 text-center">No price data available for the selected time range. Check console for details.</div>';
      } else {
          let chart, priceSeries, rsiChart, rsiSeries;
          
          try {
              console.log('Creating chart with', priceData.length, 'data points');
              console.log('LightweightCharts object:', typeof LightweightCharts, LightweightCharts);
              
              // Check if createChart exists
              if (!LightweightCharts || !LightweightCharts.createChart) {
                  throw new Error('LightweightCharts.createChart is not available. Library may not have loaded correctly.');
              }
              
              chart = LightweightCharts.createChart(chartContainer, {
                  ...chartOptions,
                  width: chartContainer.clientWidth,
                  height: 500,
              });

              console.log('Chart created:', chart);
              console.log('Chart methods:', Object.keys(chart).filter(k => k.includes('Series')));
              
              // Check if addLineSeries exists, if not try addSeries (v5.x API)
              if (typeof chart.addLineSeries === 'function') {
                  // v4.x API
                  priceSeries = chart.addLineSeries({
                      color: '#3b82f6',
                      lineWidth: 2,
                      priceFormat: {
                          type: 'price',
                          precision: 2,
                          minMove: 0.01,
                      },
                      lastValueVisible: true,
                      priceLineVisible: true,
                  });
              } else if (typeof chart.addSeries === 'function' && LightweightCharts.LineSeries) {
                  // v5.x API
                  priceSeries = chart.addSeries(LightweightCharts.LineSeries, {
                      color: '#3b82f6',
                      lineWidth: 2,
                      priceFormat: {
                          type: 'price',
                          precision: 2,
                          minMove: 0.01,
                      },
                      lastValueVisible: true,
                      priceLineVisible: true,
                  });
              } else {
                  throw new Error('Neither addLineSeries nor addSeries(LineSeries) is available. Chart library version issue.');
              }

              // Set price data
              if (priceData.length > 0) {
                  priceSeries.setData(priceData);
                  console.log('Price data set successfully');

                  // Add markers for buy/sell/hold signals
                  const allMarkers = [...buyMarkers, ...sellMarkers];
                  if (allMarkers.length > 0) {
                      priceSeries.setMarkers(allMarkers);
                      console.log('RSI-based markers set:', allMarkers.length, '(Buy:', buyMarkers.length, 'Sell:', sellMarkers.length, ')');
                  }
              } else {
                  console.error('No price data to display!');
                  // Show error message
                  chartContainer.innerHTML = '<div class="text-white p-4 text-center">No price data available for the selected time range.</div>';
              }

              // Update price display on crosshair move
              chart.subscribeCrosshairMove(param => {
                  if (param.point === undefined || !param.time || param.seriesData.size === 0) {
                      return;
                  }
                  const price = param.seriesData.get(priceSeries);
                  if (price) {
                      const currentPrice = price.value;
                      const firstPrice = prices[0];
                      const change = currentPrice - firstPrice;
                      const changePercent = ((change / firstPrice) * 100).toFixed(2);
                      
                      document.getElementById('chart-price').textContent = `$${currentPrice.toFixed(2)}`;
                      const changeEl = document.getElementById('chart-change');
                      changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent}%)`;
                      changeEl.className = change >= 0 ? 'ml-2 text-green-400' : 'ml-2 text-red-400';
                  }
              });

              // Create RSI chart below
              const rsiChartContainer = document.getElementById('rsi-chart');
              if (rsiChartContainer) {
                  rsiChart = LightweightCharts.createChart(rsiChartContainer, {
                      ...chartOptions,
                      height: 150,
                      rightPriceScale: {
                          ...chartOptions.rightPriceScale,
                          visible: true,
                          scaleMargins: {
                              top: 0.1,
                              bottom: 0.1,
                          },
                      },
                  });

                  // Check API version for RSI series
                  if (typeof rsiChart.addLineSeries === 'function') {
                      // v4.x API
                      rsiSeries = rsiChart.addLineSeries({
                          color: '#d97706',
                          lineWidth: 1,
                          priceFormat: {
                              type: 'price',
                              precision: 2,
                              minMove: 0.01,
                          },
                      });
                  } else if (typeof rsiChart.addSeries === 'function' && LightweightCharts.LineSeries) {
                      // v5.x API
                      rsiSeries = rsiChart.addSeries(LightweightCharts.LineSeries, {
                          color: '#d97706',
                          lineWidth: 1,
                          priceFormat: {
                              type: 'price',
                              precision: 2,
                              minMove: 0.01,
                          },
                      });
                  } else {
                      console.error('Cannot create RSI series - API not available');
                      rsiSeries = null;
                  }
                  
                  if (rsiSeries && rsiData.length > 0) {
                      rsiSeries.setData(rsiData);

                      // Add RSI overbought/oversold lines
                      rsiSeries.createPriceLine({
                          price: 70,
                          color: '#ef4444',
                          lineWidth: 1,
                          lineStyle: 2,
                          axisLabelVisible: true,
                          title: 'Overbought',
                      });

                      rsiSeries.createPriceLine({
                          price: 30,
                          color: '#10b981',
                          lineWidth: 1,
                          lineStyle: 2,
                          axisLabelVisible: true,
                          title: 'Oversold',
                      });
                  } else {
                      console.warn('No RSI data available');
                  }

                  // Synchronize crosshair between charts
                  if (chart && rsiChart && rsiSeries) {
                      chart.subscribeCrosshairMove(param => {
                          if (param.time && rsiChart) {
                              rsiChart.setCrosshairPosition(param.time, param.point);
                          }
                      });

                      rsiChart.subscribeCrosshairMove(param => {
                          if (param.time && chart) {
                              chart.setCrosshairPosition(param.time, param.point);
                          }
                      });

                      // Handle window resize
                      window.addEventListener('resize', () => {
                          if (chart) chart.applyOptions({ width: chartContainer.clientWidth });
                          if (rsiChart) rsiChart.applyOptions({ width: rsiChartContainer.clientWidth });
                      });
                  }
              } // Close rsiChartContainer if block
          } catch (error) {
              console.error('Error creating chart:', error);
              chartContainer.innerHTML = '<div class="text-white p-4 text-center">Error creating chart: ' + error.message + '</div>';
          }
      } // Close else block (priceData.length > 0)

      // Set initial price display
      if (prices && prices.length > 0) {
          const lastPrice = prices[prices.length - 1];
          const firstPrice = prices[0];
          const change = lastPrice - firstPrice;
          const changePercent = firstPrice > 0 ? ((change / firstPrice) * 100).toFixed(2) : '0.00';
          
          const priceEl = document.getElementById('chart-price');
          const changeEl = document.getElementById('chart-change');
          
          if (priceEl) {
              priceEl.textContent = `$${lastPrice.toFixed(2)}`;
          }
          
          if (changeEl) {
              changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent}%)`;
              changeEl.className = change >= 0 ? 'ml-2 text-green-400' : 'ml-2 text-red-400';
          }
      } else {
          console.warn('No prices available for display');
          const priceEl = document.getElementById('chart-price');
          if (priceEl) {
              priceEl.textContent = 'No Data';
          }
      }
      } // End initChart function
      
      // Wait for library to load, then initialize chart
      if (typeof LightweightCharts !== 'undefined') {
          initChart();
      } else {
          // Wait for library to load
          window.addEventListener('load', function() {
              if (typeof LightweightCharts !== 'undefined') {
                  initChart();
              } else {
                  console.error('TradingView Lightweight Charts failed to load');
                  const chartContainer = document.getElementById('tradingview-chart');
                  if (chartContainer) {
                      chartContainer.innerHTML = '<div class="text-white p-4 text-center">Chart library failed to load. Please refresh the page.</div>';
                  }
              }
          });
      }
  </script>
</body>
</html>
