<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SOL Price Tracker - RSI Trading Signals</title>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- TradingView Lightweight Charts - Professional Trading Chart Library -->
    <!-- Using v4.x for compatibility (v5.x has breaking API changes) -->
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        /* Professional Trading Chart Styles */
        #tradingview-chart {
            width: 100%;
            height: 500px;
            background: #1a1a1a;
            border-radius: 8px;
            position: relative;
        }
        #rsi-chart {
            width: 100%;
            height: 150px;
            background: #1a1a1a;
            border-radius: 8px;
            margin-top: 10px;
        }
        .chart-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .signal-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        .signal-buy { background: #10b981; }
        .signal-sell { background: #ef4444; }
        .signal-hold { background: #f59e0b; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Navigation Header -->
    <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="/" class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-blue-500 rounded-lg flex items-center justify-center">
                            <span class="text-2xl">üêã</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-white">Orca Tracker</h1>
                            <p class="text-xs text-gray-400">Solana Rewards & Trading</p>
                        </div>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition text-sm font-medium">
                        Home
                    </a>
                    <a href="/orca" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition text-sm font-medium">
                        Rewards
                    </a>
                    <a href="/sol-tracker" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 rounded-lg transition text-sm font-medium">
                        SOL Tracker
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <!-- Large Price Display - Top Priority -->
        <div class="mb-8 fade-in">
            <div class="bg-gradient-to-r {% if stats.percent_change is not none and stats.percent_change > 0 %}from-green-600 to-emerald-600{% elif stats.percent_change is not none and stats.percent_change < 0 %}from-red-600 to-rose-600{% else %}from-purple-600 to-blue-600{% endif %} rounded-2xl shadow-2xl p-8 border-2 {% if stats.percent_change is not none and stats.percent_change > 0 %}border-green-400{% elif stats.percent_change is not none and stats.percent_change < 0 %}border-red-400{% else %}border-purple-400{% endif %}">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="flex items-center space-x-6 mb-4 md:mb-0">
                        <div class="text-6xl md:text-7xl">
                            {% if stats.percent_change_display is not none and stats.percent_change_display > 0 %}
                                üìà
                            {% elif stats.percent_change_display is not none and stats.percent_change_display < 0 %}
                                üìâ
                            {% else %}
                                üí∞
                            {% endif %}
                        </div>
                        <div>
                            <div class="text-sm md:text-base text-white/80 mb-2 font-medium">SOLANA (SOL)</div>
                            <div class="text-5xl md:text-6xl font-extrabold text-white">
                                ${{ "%.2f"|format(stats.current_price) if stats.current_price is not none else 'N/A' }}
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-start md:items-end space-y-2">
                        <div class="text-sm text-white/80 font-medium">24h Change</div>
                        <div class="flex items-center space-x-3">
                            {% if stats.percent_change_display is not none %}
                                <div class="text-4xl md:text-5xl font-extrabold text-white">
                                    {% if stats.percent_change_display > 0 %}‚¨ÜÔ∏è{% elif stats.percent_change_display < 0 %}‚¨áÔ∏è{% else %}‚û°Ô∏è{% endif %}
                                    {{ "%.2f"|format(stats.percent_change_display) }}%
                                </div>
                                <div class="text-xs text-white/70 mt-2">24h</div>
                            {% else %}
                                <div class="text-4xl md:text-5xl font-extrabold text-white/50">N/A</div>
                            {% endif %}
                        </div>
                        {% if stats.high is not none and stats.low is not none %}
                            <div class="text-sm text-white/70 mt-2">
                                High: ${{ "%.2f"|format(stats.high) }} / Low: ${{ "%.2f"|format(stats.low) }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Time Range Selector -->
            <div class="mt-4 flex justify-end">
                <form method="get" action="/sol-tracker" class="flex items-center space-x-2">
                    <label for="range" class="text-sm font-medium text-gray-300">Time Range:</label>
                    <select id="range" name="range" onchange="this.form.submit()" class="bg-gray-700 border border-gray-600 text-gray-100 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2 shadow-sm hover:bg-gray-600 transition">
                        <option value="hour" {% if selected_range == 'hour' %}selected{% endif %}>1 Hour</option>
                        <option value="day" {% if selected_range == 'day' %}selected{% endif %}>1 Day</option>
                        <option value="week" {% if selected_range == 'week' %}selected{% endif %}>1 Week</option>
                        <option value="month" {% if selected_range == 'month' %}selected{% endif %}>1 Month</option>
                        <option value="year" {% if selected_range == 'year' %}selected{% endif %}>1 Year</option>
                    </select>
                </form>
            </div>
        </div>

        <!-- Professional Trading Chart - Second Priority -->
        <div class="mb-8 fade-in">
            <div class="chart-container">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white">SOL/USD Price Chart</h2>
                    <div class="text-sm text-gray-400">
                        <span id="chart-price" class="text-2xl font-bold text-green-400">$0.00</span>
                        <span id="chart-change" class="ml-2"></span>
                    </div>
                </div>
                <div id="tradingview-chart"></div>
                <div id="rsi-chart"></div>
            </div>
        </div>

        <!-- RSI-Based Trading Signal -->
        <div class="mb-8 fade-in">
          {% if stats.rsi is not none %}
            {% if stats.rsi < 30 %}
              <!-- BUY Signal - RSI Oversold -->
              <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl shadow-2xl p-8 border-2 border-green-400 animate-pulse">
                <div class="text-center">
                  <div class="text-5xl font-extrabold mb-4 flex items-center justify-center space-x-4">
                    <span>üü¢ BUY SIGNAL</span>
                  </div>
                  <div class="text-2xl mb-4 opacity-90">RSI indicates oversold conditions</div>
                  <div class="grid grid-cols-3 gap-6 mt-6">
                    <div class="bg-white/10 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">RSI Value</div>
                      <div class="text-3xl font-bold">{{ "%.1f"|format(stats.rsi) }}</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">Current Price</div>
                      <div class="text-3xl font-bold">${{ "%.2f"|format(stats.current_price) if stats.current_price is not none else 'N/A' }}</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">Signal Strength</div>
                      <div class="text-3xl font-bold">Strong</div>
                    </div>
                  </div>
                  <div class="mt-6 text-sm opacity-75 italic">
                    RSI below 30 suggests potential buying opportunity. Consider entering long positions.
                  </div>
                </div>
              </div>
            {% elif stats.rsi > 70 %}
              <!-- SELL Signal - RSI Overbought -->
              <div class="bg-gradient-to-r from-red-600 to-pink-600 text-white rounded-xl shadow-2xl p-8 border-2 border-red-400 animate-pulse">
                <div class="text-center">
                  <div class="text-5xl font-extrabold mb-4 flex items-center justify-center space-x-4">
                    <span>üî¥ SELL SIGNAL</span>
                  </div>
                  <div class="text-2xl mb-4 opacity-90">RSI indicates overbought conditions</div>
                  <div class="grid grid-cols-3 gap-6 mt-6">
                    <div class="bg-white/10 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">RSI Value</div>
                      <div class="text-3xl font-bold">{{ "%.1f"|format(stats.rsi) }}</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">Current Price</div>
                      <div class="text-3xl font-bold">${{ "%.2f"|format(stats.current_price) if stats.current_price is not none else 'N/A' }}</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">Signal Strength</div>
                      <div class="text-3xl font-bold">Strong</div>
                    </div>
                  </div>
                  <div class="mt-6 text-sm opacity-75 italic">
                    RSI above 70 suggests potential selling opportunity. Consider taking profits or entering short positions.
                  </div>
                </div>
              </div>
            {% else %}
              <!-- HOLD Signal - RSI Neutral -->
              <div class="bg-gradient-to-r from-gray-700 to-gray-800 text-white rounded-xl shadow-xl p-8 border border-gray-600">
                <div class="text-center">
                  <div class="text-5xl font-extrabold mb-4 flex items-center justify-center space-x-4">
                    <span>üü° HOLD SIGNAL</span>
                  </div>
                  <div class="text-2xl mb-4 opacity-90">RSI indicates neutral conditions</div>
                  <div class="grid grid-cols-3 gap-6 mt-6">
                    <div class="bg-gray-600/30 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">RSI Value</div>
                      <div class="text-3xl font-bold">{{ "%.1f"|format(stats.rsi) }}</div>
                    </div>
                    <div class="bg-gray-600/30 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">Current Price</div>
                      <div class="text-3xl font-bold">${{ "%.2f"|format(stats.current_price) if stats.current_price is not none else 'N/A' }}</div>
                    </div>
                    <div class="bg-gray-600/30 rounded-lg p-4">
                      <div class="text-sm opacity-80 mb-1">Signal Strength</div>
                      <div class="text-3xl font-bold">Neutral</div>
                    </div>
                  </div>
                  <div class="mt-6 text-sm opacity-75 italic">
                    RSI between 30-70 suggests neutral market conditions. Wait for clearer signals before taking action.
                  </div>
                </div>
              </div>
            {% endif %}
          {% else %}
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-8 text-center">
              <div class="text-xl font-semibold text-gray-400">Insufficient data for RSI calculation</div>
              <div class="text-sm text-gray-500 mt-2">Need at least 15 price points to calculate RSI</div>
            </div>
          {% endif %}
        </div>

        <!-- Comprehensive Technical Signals Panel -->
        <div class="mb-8 fade-in">
          <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center space-x-2">
              <span>üìä</span>
              <span>Technical Indicator Signals</span>
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              
              <!-- RSI Signal -->
              {% if stats.rsi is not none %}
                {% if stats.rsi < 30 %}
                  {% set rsi_signal = 'BUY' %}
                  {% set rsi_color = 'green' %}
                  {% set rsi_arrow = '‚¨ÜÔ∏è' %}
                  {% set rsi_message = 'Oversold - Buy Opportunity' %}
                {% elif stats.rsi > 70 %}
                  {% set rsi_signal = 'SELL' %}
                  {% set rsi_color = 'red' %}
                  {% set rsi_arrow = '‚¨áÔ∏è' %}
                  {% set rsi_message = 'Overbought - Sell Opportunity' %}
                {% else %}
                  {% set rsi_signal = 'HOLD' %}
                  {% set rsi_color = 'yellow' %}
                  {% set rsi_arrow = '‚û°Ô∏è' %}
                  {% set rsi_message = 'Neutral - Wait for Clear Signal' %}
                {% endif %}
              {% else %}
                {% set rsi_signal = 'N/A' %}
                {% set rsi_color = 'gray' %}
                {% set rsi_arrow = '‚Äî' %}
                {% set rsi_message = 'Insufficient Data' %}
              {% endif %}
              
              <div class="bg-gray-700/50 rounded-lg p-4 border {% if rsi_color == 'green' %}border-green-500/50{% elif rsi_color == 'red' %}border-red-500/50{% elif rsi_color == 'yellow' %}border-yellow-500/50{% else %}border-gray-600{% endif %}">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-semibold text-gray-300">RSI (14)</span>
                  <span class="text-2xl">{{ rsi_arrow }}</span>
                </div>
                <div class="flex items-center space-x-2 mb-1">
                  <span class="text-lg font-bold {% if rsi_color == 'green' %}text-green-400{% elif rsi_color == 'red' %}text-red-400{% elif rsi_color == 'yellow' %}text-yellow-400{% else %}text-gray-400{% endif %}">
                    {{ rsi_signal }}
                  </span>
                  {% if stats.rsi is not none %}
                    <span class="text-sm text-gray-400">({{ "%.1f"|format(stats.rsi) }})</span>
                  {% endif %}
                </div>
                <p class="text-xs text-gray-400">{{ rsi_message }}</p>
              </div>

              <!-- Price vs SMA 1h -->
              {% if stats.price_vs_sma_1h is not none %}
                {% if stats.price_vs_sma_1h > 2 %}
                  {% set sma1h_signal = 'BULLISH' %}
                  {% set sma1h_color = 'green' %}
                  {% set sma1h_arrow = '‚¨ÜÔ∏è' %}
                  {% set sma1h_message = 'Price well above 1h average' %}
                {% elif stats.price_vs_sma_1h < -2 %}
                  {% set sma1h_signal = 'BEARISH' %}
                  {% set sma1h_color = 'red' %}
                  {% set sma1h_arrow = '‚¨áÔ∏è' %}
                  {% set sma1h_message = 'Price well below 1h average' %}
                {% else %}
                  {% set sma1h_signal = 'NEUTRAL' %}
                  {% set sma1h_color = 'gray' %}
                  {% set sma1h_arrow = '‚û°Ô∏è' %}
                  {% set sma1h_message = 'Price near 1h average' %}
                {% endif %}
              {% else %}
                {% set sma1h_signal = 'N/A' %}
                {% set sma1h_color = 'gray' %}
                {% set sma1h_arrow = '‚Äî' %}
                {% set sma1h_message = 'Insufficient Data' %}
              {% endif %}
              
              <div class="bg-gray-700/50 rounded-lg p-4 border {% if sma1h_color == 'green' %}border-green-500/50{% elif sma1h_color == 'red' %}border-red-500/50{% else %}border-gray-600{% endif %}">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-semibold text-gray-300">Price vs SMA (1h)</span>
                  <span class="text-2xl">{{ sma1h_arrow }}</span>
                </div>
                <div class="flex items-center space-x-2 mb-1">
                  <span class="text-lg font-bold {% if sma1h_color == 'green' %}text-green-400{% elif sma1h_color == 'red' %}text-red-400{% else %}text-gray-400{% endif %}">
                    {{ sma1h_signal }}
                  </span>
                  {% if stats.price_vs_sma_1h is not none %}
                    <span class="text-sm text-gray-400">({{ "%+.2f"|format(stats.price_vs_sma_1h) }}%)</span>
                  {% endif %}
                </div>
                <p class="text-xs text-gray-400">{{ sma1h_message }}</p>
              </div>

              <!-- Price vs SMA 4h -->
              {% if stats.price_vs_sma_4h is not none %}
                {% if stats.price_vs_sma_4h > 2 %}
                  {% set sma4h_signal = 'BULLISH' %}
                  {% set sma4h_color = 'green' %}
                  {% set sma4h_arrow = '‚¨ÜÔ∏è' %}
                  {% set sma4h_message = 'Price well above 4h average' %}
                {% elif stats.price_vs_sma_4h < -2 %}
                  {% set sma4h_signal = 'BEARISH' %}
                  {% set sma4h_color = 'red' %}
                  {% set sma4h_arrow = '‚¨áÔ∏è' %}
                  {% set sma4h_message = 'Price well below 4h average' %}
                {% else %}
                  {% set sma4h_signal = 'NEUTRAL' %}
                  {% set sma4h_color = 'gray' %}
                  {% set sma4h_arrow = '‚û°Ô∏è' %}
                  {% set sma4h_message = 'Price near 4h average' %}
                {% endif %}
              {% else %}
                {% set sma4h_signal = 'N/A' %}
                {% set sma4h_color = 'gray' %}
                {% set sma4h_arrow = '‚Äî' %}
                {% set sma4h_message = 'Insufficient Data' %}
              {% endif %}
              
              <div class="bg-gray-700/50 rounded-lg p-4 border {% if sma4h_color == 'green' %}border-green-500/50{% elif sma4h_color == 'red' %}border-red-500/50{% else %}border-gray-600{% endif %}">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-semibold text-gray-300">Price vs SMA (4h)</span>
                  <span class="text-2xl">{{ sma4h_arrow }}</span>
                </div>
                <div class="flex items-center space-x-2 mb-1">
                  <span class="text-lg font-bold {% if sma4h_color == 'green' %}text-green-400{% elif sma4h_color == 'red' %}text-red-400{% else %}text-gray-400{% endif %}">
                    {{ sma4h_signal }}
                  </span>
                  {% if stats.price_vs_sma_4h is not none %}
                    <span class="text-sm text-gray-400">({{ "%+.2f"|format(stats.price_vs_sma_4h) }}%)</span>
                  {% endif %}
                </div>
                <p class="text-xs text-gray-400">{{ sma4h_message }}</p>
              </div>

              <!-- Price vs SMA 24h -->
              {% if stats.price_vs_sma_24h is not none %}
                {% if stats.price_vs_sma_24h > 2 %}
                  {% set sma24h_signal = 'BULLISH' %}
                  {% set sma24h_color = 'green' %}
                  {% set sma24h_arrow = '‚¨ÜÔ∏è' %}
                  {% set sma24h_message = 'Price well above 24h average' %}
                {% elif stats.price_vs_sma_24h < -2 %}
                  {% set sma24h_signal = 'BEARISH' %}
                  {% set sma24h_color = 'red' %}
                  {% set sma24h_arrow = '‚¨áÔ∏è' %}
                  {% set sma24h_message = 'Price well below 24h average' %}
                {% else %}
                  {% set sma24h_signal = 'NEUTRAL' %}
                  {% set sma24h_color = 'gray' %}
                  {% set sma24h_arrow = '‚û°Ô∏è' %}
                  {% set sma24h_message = 'Price near 24h average' %}
                {% endif %}
              {% else %}
                {% set sma24h_signal = 'N/A' %}
                {% set sma24h_color = 'gray' %}
                {% set sma24h_arrow = '‚Äî' %}
                {% set sma24h_message = 'Insufficient Data' %}
              {% endif %}
              
              <div class="bg-gray-700/50 rounded-lg p-4 border {% if sma24h_color == 'green' %}border-green-500/50{% elif sma24h_color == 'red' %}border-red-500/50{% else %}border-gray-600{% endif %}">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-semibold text-gray-300">Price vs SMA (24h)</span>
                  <span class="text-2xl">{{ sma24h_arrow }}</span>
                </div>
                <div class="flex items-center space-x-2 mb-1">
                  <span class="text-lg font-bold {% if sma24h_color == 'green' %}text-green-400{% elif sma24h_color == 'red' %}text-red-400{% else %}text-gray-400{% endif %}">
                    {{ sma24h_signal }}
                  </span>
                  {% if stats.price_vs_sma_24h is not none %}
                    <span class="text-sm text-gray-400">({{ "%+.2f"|format(stats.price_vs_sma_24h) }}%)</span>
                  {% endif %}
                </div>
                <p class="text-xs text-gray-400">{{ sma24h_message }}</p>
              </div>

              <!-- MACD Signal -->
              {% if stats.macd_line is not none and stats.macd_signal is not none %}
                {% if stats.macd_line > stats.macd_signal and stats.macd_histogram > 0 %}
                  {% set macd_signal = 'BULLISH' %}
                  {% set macd_color = 'green' %}
                  {% set macd_arrow = '‚¨ÜÔ∏è' %}
                  {% set macd_message = 'MACD above signal - Uptrend' %}
                {% elif stats.macd_line < stats.macd_signal and stats.macd_histogram < 0 %}
                  {% set macd_signal = 'BEARISH' %}
                  {% set macd_color = 'red' %}
                  {% set macd_arrow = '‚¨áÔ∏è' %}
                  {% set macd_message = 'MACD below signal - Downtrend' %}
                {% else %}
                  {% set macd_signal = 'NEUTRAL' %}
                  {% set macd_color = 'gray' %}
                  {% set macd_arrow = '‚û°Ô∏è' %}
                  {% set macd_message = 'MACD crossing - Wait' %}
                {% endif %}
              {% else %}
                {% set macd_signal = 'N/A' %}
                {% set macd_color = 'gray' %}
                {% set macd_arrow = '‚Äî' %}
                {% set macd_message = 'Insufficient Data' %}
              {% endif %}
              
              <div class="bg-gray-700/50 rounded-lg p-4 border {% if macd_color == 'green' %}border-green-500/50{% elif macd_color == 'red' %}border-red-500/50{% else %}border-gray-600{% endif %}">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-semibold text-gray-300">MACD</span>
                  <span class="text-2xl">{{ macd_arrow }}</span>
                </div>
                <div class="flex items-center space-x-2 mb-1">
                  <span class="text-lg font-bold {% if macd_color == 'green' %}text-green-400{% elif macd_color == 'red' %}text-red-400{% else %}text-gray-400{% endif %}">
                    {{ macd_signal }}
                  </span>
                  {% if stats.macd_histogram is not none %}
                    <span class="text-sm text-gray-400">({{ "%+.4f"|format(stats.macd_histogram) }})</span>
                  {% endif %}
                </div>
                <p class="text-xs text-gray-400">{{ macd_message }}</p>
              </div>

              <!-- Bollinger Bands Position -->
              {% if stats.bb_position is not none %}
                {% if stats.bb_position > 80 %}
                  {% set bb_signal = 'OVERBOUGHT' %}
                  {% set bb_color = 'red' %}
                  {% set bb_arrow = '‚¨áÔ∏è' %}
                  {% set bb_message = 'Price near upper band - Sell zone' %}
                {% elif stats.bb_position < 20 %}
                  {% set bb_signal = 'OVERSOLD' %}
                  {% set bb_color = 'green' %}
                  {% set bb_arrow = '‚¨ÜÔ∏è' %}
                  {% set bb_message = 'Price near lower band - Buy zone' %}
                {% else %}
                  {% set bb_signal = 'NEUTRAL' %}
                  {% set bb_color = 'gray' %}
                  {% set bb_arrow = '‚û°Ô∏è' %}
                  {% set bb_message = 'Price in middle range' %}
                {% endif %}
              {% else %}
                {% set bb_signal = 'N/A' %}
                {% set bb_color = 'gray' %}
                {% set bb_arrow = '‚Äî' %}
                {% set bb_message = 'Insufficient Data' %}
              {% endif %}
              
              <div class="bg-gray-700/50 rounded-lg p-4 border {% if bb_color == 'green' %}border-green-500/50{% elif bb_color == 'red' %}border-red-500/50{% else %}border-gray-600{% endif %}">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-semibold text-gray-300">Bollinger Bands</span>
                  <span class="text-2xl">{{ bb_arrow }}</span>
                </div>
                <div class="flex items-center space-x-2 mb-1">
                  <span class="text-lg font-bold {% if bb_color == 'green' %}text-green-400{% elif bb_color == 'red' %}text-red-400{% else %}text-gray-400{% endif %}">
                    {{ bb_signal }}
                  </span>
                  {% if stats.bb_position is not none %}
                    <span class="text-sm text-gray-400">({{ "%.0f"|format(stats.bb_position) }}%)</span>
                  {% endif %}
                </div>
                <p class="text-xs text-gray-400">{{ bb_message }}</p>
              </div>

              <!-- Momentum -->
              {% if stats.momentum_10 is not none %}
                {% if stats.momentum_10 > 1 %}
                  {% set momentum_signal = 'BULLISH' %}
                  {% set momentum_color = 'green' %}
                  {% set momentum_arrow = '‚¨ÜÔ∏è' %}
                  {% set momentum_message = 'Strong upward momentum' %}
                {% elif stats.momentum_10 < -1 %}
                  {% set momentum_signal = 'BEARISH' %}
                  {% set momentum_color = 'red' %}
                  {% set momentum_arrow = '‚¨áÔ∏è' %}
                  {% set momentum_message = 'Strong downward momentum' %}
                {% else %}
                  {% set momentum_signal = 'NEUTRAL' %}
                  {% set momentum_color = 'gray' %}
                  {% set momentum_arrow = '‚û°Ô∏è' %}
                  {% set momentum_message = 'Weak momentum' %}
                {% endif %}
              {% else %}
                {% set momentum_signal = 'N/A' %}
                {% set momentum_color = 'gray' %}
                {% set momentum_arrow = '‚Äî' %}
                {% set momentum_message = 'Insufficient Data' %}
              {% endif %}
              
              <div class="bg-gray-700/50 rounded-lg p-4 border {% if momentum_color == 'green' %}border-green-500/50{% elif momentum_color == 'red' %}border-red-500/50{% else %}border-gray-600{% endif %}">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-semibold text-gray-300">Momentum (10)</span>
                  <span class="text-2xl">{{ momentum_arrow }}</span>
                </div>
                <div class="flex items-center space-x-2 mb-1">
                  <span class="text-lg font-bold {% if momentum_color == 'green' %}text-green-400{% elif momentum_color == 'red' %}text-red-400{% else %}text-gray-400{% endif %}">
                    {{ momentum_signal }}
                  </span>
                  {% if stats.momentum_10 is not none %}
                    <span class="text-sm text-gray-400">({{ "%+.2f"|format(stats.momentum_10) }}%)</span>
                  {% endif %}
                </div>
                <p class="text-xs text-gray-400">{{ momentum_message }}</p>
              </div>

            </div>

            <!-- Overall Signal Summary -->
            <div class="mt-6 pt-4 border-t border-gray-700">
              <div class="flex items-center justify-between">
                <span class="text-sm font-semibold text-gray-300">Signal Consensus:</span>
                <div class="flex items-center space-x-2">
                  {% set bullish_count = 0 %}
                  {% set bearish_count = 0 %}
                  {% set neutral_count = 0 %}
                  
                  {% if rsi_signal == 'BUY' or rsi_signal == 'SELL' %}
                    {% if rsi_signal == 'BUY' %}{% set bullish_count = bullish_count + 1 %}{% else %}{% set bearish_count = bearish_count + 1 %}{% endif %}
                  {% else %}{% set neutral_count = neutral_count + 1 %}{% endif %}
                  
                  {% if sma1h_signal == 'BULLISH' %}{% set bullish_count = bullish_count + 1 %}
                  {% elif sma1h_signal == 'BEARISH' %}{% set bearish_count = bearish_count + 1 %}
                  {% else %}{% set neutral_count = neutral_count + 1 %}{% endif %}
                  
                  {% if sma4h_signal == 'BULLISH' %}{% set bullish_count = bullish_count + 1 %}
                  {% elif sma4h_signal == 'BEARISH' %}{% set bearish_count = bearish_count + 1 %}
                  {% else %}{% set neutral_count = neutral_count + 1 %}{% endif %}
                  
                  {% if sma24h_signal == 'BULLISH' %}{% set bullish_count = bullish_count + 1 %}
                  {% elif sma24h_signal == 'BEARISH' %}{% set bearish_count = bearish_count + 1 %}
                  {% else %}{% set neutral_count = neutral_count + 1 %}{% endif %}
                  
                  {% if macd_signal == 'BULLISH' %}{% set bullish_count = bullish_count + 1 %}
                  {% elif macd_signal == 'BEARISH' %}{% set bearish_count = bearish_count + 1 %}
                  {% else %}{% set neutral_count = neutral_count + 1 %}{% endif %}
                  
                  {% if bb_signal == 'OVERSOLD' %}{% set bullish_count = bullish_count + 1 %}
                  {% elif bb_signal == 'OVERBOUGHT' %}{% set bearish_count = bearish_count + 1 %}
                  {% else %}{% set neutral_count = neutral_count + 1 %}{% endif %}
                  
                  {% if momentum_signal == 'BULLISH' %}{% set bullish_count = bullish_count + 1 %}
                  {% elif momentum_signal == 'BEARISH' %}{% set bearish_count = bearish_count + 1 %}
                  {% else %}{% set neutral_count = neutral_count + 1 %}{% endif %}
                  
                  {% if bullish_count > bearish_count and bullish_count > neutral_count %}
                    <span class="text-lg font-bold text-green-400">üü¢ BULLISH ({{ bullish_count }}/7)</span>
                  {% elif bearish_count > bullish_count and bearish_count > neutral_count %}
                    <span class="text-lg font-bold text-red-400">üî¥ BEARISH ({{ bearish_count }}/7)</span>
                  {% else %}
                    <span class="text-lg font-bold text-yellow-400">üü° MIXED ({{ neutral_count }} neutral)</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- News Sentiment Analysis -->
        {% if news_features %}
        <div class="mb-8 fade-in">
          <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center space-x-2">
              <span>üì∞</span>
              <span>News Sentiment Analysis (24h)</span>
            </h2>
            
            {% if news_features.news_count > 0 %}
              {% set sentiment_score = news_features.news_sentiment_score %}
              {% set sentiment_label = news_features.news_sentiment_label %}
              
              {% if sentiment_score > 0.3 %}
                {% set sentiment_color = 'green' %}
                {% set sentiment_icon = 'üìà' %}
                {% set sentiment_message = 'Positive news sentiment - generally bullish for crypto' %}
              {% elif sentiment_score < -0.3 %}
                {% set sentiment_color = 'red' %}
                {% set sentiment_icon = 'üìâ' %}
                {% set sentiment_message = 'Negative news sentiment - generally bearish for crypto' %}
              {% else %}
                {% set sentiment_color = 'yellow' %}
                {% set sentiment_icon = '‚û°Ô∏è' %}
                {% set sentiment_message = 'Neutral news sentiment - mixed signals' %}
              {% endif %}
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Main Sentiment Card -->
                <div class="bg-gradient-to-br {% if sentiment_color == 'green' %}from-green-600 to-emerald-600{% elif sentiment_color == 'red' %}from-red-600 to-rose-600{% else %}from-yellow-600 to-amber-600{% endif %} rounded-xl p-6 border-2 {% if sentiment_color == 'green' %}border-green-400{% elif sentiment_color == 'red' %}border-red-400{% else %}border-yellow-400{% endif %}">
                  <div class="flex items-center justify-between mb-4">
                    <span class="text-4xl">{{ sentiment_icon }}</span>
                    <span class="text-sm font-semibold text-white/80 uppercase tracking-wide">{{ sentiment_label }}</span>
                  </div>
                  <div class="mb-2">
                    <p class="text-sm text-white/90 mb-1">Sentiment Score</p>
                    <p class="text-3xl font-bold text-white">{{ "%.2f"|format(sentiment_score) }}</p>
                    <p class="text-xs text-white/70 mt-1">Range: -1.0 (very bad) to +1.0 (very good)</p>
                  </div>
                  <p class="text-sm text-white/90 italic">{{ sentiment_message }}</p>
                </div>
                
                <!-- News Statistics -->
                <div class="bg-gray-700/50 rounded-xl p-6 border border-gray-600">
                  <h3 class="text-lg font-semibold text-white mb-4">News Statistics</h3>
                  <div class="space-y-3">
                    <div class="flex justify-between items-center">
                      <span class="text-gray-300">Total Articles</span>
                      <span class="text-xl font-bold text-white">{{ news_features.news_count }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-gray-300">Crypto-Related</span>
                      <span class="text-lg font-semibold text-blue-400">{{ news_features.news_crypto_count }}</span>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-gray-600">
                      <span class="text-gray-300">Positive</span>
                      <span class="text-lg font-semibold text-green-400">{{ news_features.news_positive_count }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-gray-300">Negative</span>
                      <span class="text-lg font-semibold text-red-400">{{ news_features.news_negative_count }}</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="mt-6 pt-4 border-t border-gray-700">
                <p class="text-xs text-gray-400 italic">
                  News sentiment is analyzed using local embeddings and sentiment classification. 
                  The system tracks news from multiple sources (crypto, finance, tech, general) and identifies 
                  crypto-related articles. Sentiment scores are based on historical training data.
                </p>
              </div>
            {% else %}
              <div class="bg-gray-700/50 rounded-lg p-8 text-center border border-gray-600">
                <div class="text-4xl mb-4">üì∞</div>
                <div class="text-xl font-semibold text-gray-300 mb-2">No Recent News</div>
                <div class="text-sm text-gray-400">
                  News articles are being fetched in the background. Check back soon for sentiment analysis.
                </div>
              </div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Latest Bandit Recommendation -->
        {% if latest_bandit %}
        <div class="mb-8 fade-in">
          <div class="bg-gradient-to-r from-purple-800 to-indigo-800 text-white rounded-xl shadow-2xl p-8 border-2 border-purple-500">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold flex items-center space-x-3">
                <span>ü§ñ</span>
                <span>Contextual Bandit Recommendation</span>
              </h2>
              <div class="text-sm text-purple-200">
                {{ latest_bandit.timestamp }}
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Action Recommendation -->
              <div class="bg-white/10 rounded-lg p-6">
                <div class="text-sm text-purple-200 mb-2">Recommended Action</div>
                <div class="flex items-center space-x-4">
                  {% if latest_bandit.action == 'buy' %}
                    <div class="text-5xl font-extrabold text-green-400">üü¢ BUY</div>
                  {% elif latest_bandit.action == 'sell' %}
                    <div class="text-5xl font-extrabold text-red-400">üî¥ SELL</div>
                  {% else %}
                    <div class="text-5xl font-extrabold text-yellow-400">üü° HOLD</div>
                  {% endif %}
                  <div>
                    <div class="text-2xl font-bold">{{ latest_bandit.action|upper }}</div>
                    {% if latest_bandit.reward is not none %}
                      <div class="text-sm text-purple-200 mt-1">
                        Reward: {{ "%.4f"|format(latest_bandit.reward) }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              
              <!-- Prediction Scores -->
              <div class="bg-white/10 rounded-lg p-6">
                <div class="text-sm text-purple-200 mb-4">Prediction Scores</div>
                <div class="space-y-3">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-300">Buy Prediction:</span>
                    <span class="font-bold {% if latest_bandit.prediction_buy is not none and latest_bandit.prediction_buy > 0 %}text-green-400{% else %}text-gray-400{% endif %}">
                      {{ "%.4f"|format(latest_bandit.prediction_buy) if latest_bandit.prediction_buy is not none else 'N/A' }}
                    </span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-300">Sell Prediction:</span>
                    <span class="font-bold {% if latest_bandit.prediction_sell is not none and latest_bandit.prediction_sell > 0 %}text-red-400{% else %}text-gray-400{% endif %}">
                      {{ "%.4f"|format(latest_bandit.prediction_sell) if latest_bandit.prediction_sell is not none else 'N/A' }}
                    </span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-300">Hold Prediction:</span>
                    <span class="font-bold {% if latest_bandit.prediction_hold is not none and latest_bandit.prediction_hold > 0 %}text-yellow-400{% else %}text-gray-400{% endif %}">
                      {{ "%.4f"|format(latest_bandit.prediction_hold) if latest_bandit.prediction_hold is not none else 'N/A' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mt-6 pt-4 border-t border-purple-600/50">
              <p class="text-sm text-purple-200 italic">
                The contextual bandit algorithm analyzes market conditions and recommends actions based on learned patterns. 
                This recommendation is for informational purposes only and should be used alongside other technical indicators.
              </p>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Signal Performance & Reliability -->
        <div class="mb-8 fade-in">
          <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center space-x-2">
              <span>üìà</span>
              <span>Signal Reliability & Performance</span>
            </h2>
            <p class="text-sm text-gray-400 mb-6">Track how reliable each signal type has been over time (24-hour performance)</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              
              <!-- RSI Buy Signal Performance -->
              {% if performance_stats.rsi_buy and performance_stats.rsi_buy.signals_with_outcome > 0 %}
                {% set rsi_buy = performance_stats.rsi_buy %}
                <div class="bg-gray-700/50 rounded-lg p-4 border {% if rsi_buy.win_rate >= 60 %}border-green-500/50{% elif rsi_buy.win_rate >= 50 %}border-yellow-500/50{% else %}border-red-500/50{% endif %}">
                  <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-gray-300">RSI Buy Signal</span>
                    <span class="text-xs px-2 py-1 rounded {% if rsi_buy.win_rate >= 60 %}bg-green-500/20 text-green-400{% elif rsi_buy.win_rate >= 50 %}bg-yellow-500/20 text-yellow-400{% else %}bg-red-500/20 text-red-400{% endif %}">
                      {{ "%.0f"|format(rsi_buy.win_rate) }}% Win Rate
                    </span>
                  </div>
                  <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Total Signals:</span>
                      <span class="text-white font-medium">{{ rsi_buy.total_signals }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Avg Return (24h):</span>
                      <span class="{% if rsi_buy.avg_return > 0 %}text-green-400{% else %}text-red-400{% endif %} font-bold">
                        {{ "%+.2f"|format(rsi_buy.avg_return) }}%
                      </span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Best:</span>
                      <span class="text-green-400 font-medium">{{ "%+.2f"|format(rsi_buy.max_return) }}%</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Worst:</span>
                      <span class="text-red-400 font-medium">{{ "%+.2f"|format(rsi_buy.min_return) }}%</span>
                    </div>
                  </div>
                </div>
              {% else %}
                <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600">
                  <div class="text-sm font-semibold text-gray-400 mb-2">RSI Buy Signal</div>
                  <div class="text-xs text-gray-500">Insufficient data</div>
                </div>
              {% endif %}

              <!-- RSI Sell Signal Performance -->
              {% if performance_stats.rsi_sell and performance_stats.rsi_sell.signals_with_outcome > 0 %}
                {% set rsi_sell = performance_stats.rsi_sell %}
                <div class="bg-gray-700/50 rounded-lg p-4 border {% if rsi_sell.win_rate >= 60 %}border-green-500/50{% elif rsi_sell.win_rate >= 50 %}border-yellow-500/50{% else %}border-red-500/50{% endif %}">
                  <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-gray-300">RSI Sell Signal</span>
                    <span class="text-xs px-2 py-1 rounded {% if rsi_sell.win_rate >= 60 %}bg-green-500/20 text-green-400{% elif rsi_sell.win_rate >= 50 %}bg-yellow-500/20 text-yellow-400{% else %}bg-red-500/20 text-red-400{% endif %}">
                      {{ "%.0f"|format(rsi_sell.win_rate) }}% Win Rate
                    </span>
                  </div>
                  <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Total Signals:</span>
                      <span class="text-white font-medium">{{ rsi_sell.total_signals }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Avg Return (24h):</span>
                      <span class="{% if rsi_sell.avg_return > 0 %}text-green-400{% else %}text-red-400{% endif %} font-bold">
                        {{ "%+.2f"|format(rsi_sell.avg_return) }}%
                      </span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Best:</span>
                      <span class="text-green-400 font-medium">{{ "%+.2f"|format(rsi_sell.max_return) }}%</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Worst:</span>
                      <span class="text-red-400 font-medium">{{ "%+.2f"|format(rsi_sell.min_return) }}%</span>
                    </div>
                  </div>
                </div>
              {% else %}
                <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600">
                  <div class="text-sm font-semibold text-gray-400 mb-2">RSI Sell Signal</div>
                  <div class="text-xs text-gray-500">Insufficient data</div>
                </div>
              {% endif %}

              <!-- RSI Hold Signal Performance -->
              {% if performance_stats.rsi_hold and performance_stats.rsi_hold.signals_with_outcome > 0 %}
                {% set rsi_hold = performance_stats.rsi_hold %}
                <div class="bg-gray-700/50 rounded-lg p-4 border {% if rsi_hold.win_rate >= 60 %}border-green-500/50{% elif rsi_hold.win_rate >= 50 %}border-yellow-500/50{% else %}border-red-500/50{% endif %}">
                  <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-gray-300">RSI Hold Signal</span>
                    <span class="text-xs px-2 py-1 rounded {% if rsi_hold.win_rate >= 60 %}bg-green-500/20 text-green-400{% elif rsi_hold.win_rate >= 50 %}bg-yellow-500/20 text-yellow-400{% else %}bg-red-500/20 text-red-400{% endif %}">
                      {{ "%.0f"|format(rsi_hold.win_rate) }}% Win Rate
                    </span>
                  </div>
                  <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Total Signals:</span>
                      <span class="text-white font-medium">{{ rsi_hold.total_signals }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Avg Return (24h):</span>
                      <span class="{% if rsi_hold.avg_return > 0 %}text-green-400{% else %}text-red-400{% endif %} font-bold">
                        {{ "%+.2f"|format(rsi_hold.avg_return) }}%
                      </span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Best:</span>
                      <span class="text-green-400 font-medium">{{ "%+.2f"|format(rsi_hold.max_return) }}%</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Worst:</span>
                      <span class="text-red-400 font-medium">{{ "%+.2f"|format(rsi_hold.min_return) }}%</span>
                    </div>
                  </div>
                </div>
              {% else %}
                <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600">
                  <div class="text-sm font-semibold text-gray-400 mb-2">RSI Hold Signal</div>
                  <div class="text-xs text-gray-500">Insufficient data</div>
                </div>
              {% endif %}

              <!-- Bandit Buy Signal Performance -->
              {% if performance_stats.bandit_buy and performance_stats.bandit_buy.signals_with_outcome > 0 %}
                {% set bandit_buy = performance_stats.bandit_buy %}
                <div class="bg-gray-700/50 rounded-lg p-4 border {% if bandit_buy.win_rate >= 60 %}border-green-500/50{% elif bandit_buy.win_rate >= 50 %}border-yellow-500/50{% else %}border-red-500/50{% endif %}">
                  <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-gray-300">Bandit Buy Signal</span>
                    <span class="text-xs px-2 py-1 rounded {% if bandit_buy.win_rate >= 60 %}bg-green-500/20 text-green-400{% elif bandit_buy.win_rate >= 50 %}bg-yellow-500/20 text-yellow-400{% else %}bg-red-500/20 text-red-400{% endif %}">
                      {{ "%.0f"|format(bandit_buy.win_rate) }}% Win Rate
                    </span>
                  </div>
                  <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Total Signals:</span>
                      <span class="text-white font-medium">{{ bandit_buy.total_signals }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Avg Return (24h):</span>
                      <span class="{% if bandit_buy.avg_return > 0 %}text-green-400{% else %}text-red-400{% endif %} font-bold">
                        {{ "%+.2f"|format(bandit_buy.avg_return) }}%
                      </span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Best:</span>
                      <span class="text-green-400 font-medium">{{ "%+.2f"|format(bandit_buy.max_return) }}%</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Worst:</span>
                      <span class="text-red-400 font-medium">{{ "%+.2f"|format(bandit_buy.min_return) }}%</span>
                    </div>
                  </div>
                </div>
              {% else %}
                <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600">
                  <div class="text-sm font-semibold text-gray-400 mb-2">Bandit Buy Signal</div>
                  <div class="text-xs text-gray-500">Insufficient data</div>
                </div>
              {% endif %}

              <!-- Bandit Sell Signal Performance -->
              {% if performance_stats.bandit_sell and performance_stats.bandit_sell.signals_with_outcome > 0 %}
                {% set bandit_sell = performance_stats.bandit_sell %}
                <div class="bg-gray-700/50 rounded-lg p-4 border {% if bandit_sell.win_rate >= 60 %}border-green-500/50{% elif bandit_sell.win_rate >= 50 %}border-yellow-500/50{% else %}border-red-500/50{% endif %}">
                  <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-gray-300">Bandit Sell Signal</span>
                    <span class="text-xs px-2 py-1 rounded {% if bandit_sell.win_rate >= 60 %}bg-green-500/20 text-green-400{% elif bandit_sell.win_rate >= 50 %}bg-yellow-500/20 text-yellow-400{% else %}bg-red-500/20 text-red-400{% endif %}">
                      {{ "%.0f"|format(bandit_sell.win_rate) }}% Win Rate
                    </span>
                  </div>
                  <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Total Signals:</span>
                      <span class="text-white font-medium">{{ bandit_sell.total_signals }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Avg Return (24h):</span>
                      <span class="{% if bandit_sell.avg_return > 0 %}text-green-400{% else %}text-red-400{% endif %} font-bold">
                        {{ "%+.2f"|format(bandit_sell.avg_return) }}%
                      </span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Best:</span>
                      <span class="text-green-400 font-medium">{{ "%+.2f"|format(bandit_sell.max_return) }}%</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Worst:</span>
                      <span class="text-red-400 font-medium">{{ "%+.2f"|format(bandit_sell.min_return) }}%</span>
                    </div>
                  </div>
                </div>
              {% else %}
                <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600">
                  <div class="text-sm font-semibold text-gray-400 mb-2">Bandit Sell Signal</div>
                  <div class="text-xs text-gray-500">Insufficient data</div>
                </div>
              {% endif %}

              <!-- Bandit Hold Signal Performance -->
              {% if performance_stats.bandit_hold and performance_stats.bandit_hold.signals_with_outcome > 0 %}
                {% set bandit_hold = performance_stats.bandit_hold %}
                <div class="bg-gray-700/50 rounded-lg p-4 border {% if bandit_hold.win_rate >= 60 %}border-green-500/50{% elif bandit_hold.win_rate >= 50 %}border-yellow-500/50{% else %}border-red-500/50{% endif %}">
                  <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-gray-300">Bandit Hold Signal</span>
                    <span class="text-xs px-2 py-1 rounded {% if bandit_hold.win_rate >= 60 %}bg-green-500/20 text-green-400{% elif bandit_hold.win_rate >= 50 %}bg-yellow-500/20 text-yellow-400{% else %}bg-red-500/20 text-red-400{% endif %}">
                      {{ "%.0f"|format(bandit_hold.win_rate) }}% Win Rate
                    </span>
                  </div>
                  <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Total Signals:</span>
                      <span class="text-white font-medium">{{ bandit_hold.total_signals }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Avg Return (24h):</span>
                      <span class="{% if bandit_hold.avg_return > 0 %}text-green-400{% else %}text-red-400{% endif %} font-bold">
                        {{ "%+.2f"|format(bandit_hold.avg_return) }}%
                      </span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Best:</span>
                      <span class="text-green-400 font-medium">{{ "%+.2f"|format(bandit_hold.max_return) }}%</span>
                    </div>
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-400">Worst:</span>
                      <span class="text-red-400 font-medium">{{ "%+.2f"|format(bandit_hold.min_return) }}%</span>
                    </div>
                  </div>
                </div>
              {% else %}
                <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600">
                  <div class="text-sm font-semibold text-gray-400 mb-2">Bandit Hold Signal</div>
                  <div class="text-xs text-gray-500">Insufficient data</div>
                </div>
              {% endif %}

            </div>

            <!-- Summary Note -->
            <div class="mt-6 pt-4 border-t border-gray-700">
              <p class="text-xs text-gray-400 italic">
                Performance metrics are calculated based on price movement 24 hours after each signal. 
                Win rate indicates the percentage of signals that resulted in profitable outcomes. 
                Data accumulates over time as signals age and outcomes are measured.
              </p>
            </div>
          </div>
        </div>

        <!-- RL Agent Multi-Horizon Predictions -->
        <div class="mb-8 fade-in" id="rl-predictions-section">
          <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center space-x-2">
              <span>üîÆ</span>
              <span>RL Agent Multi-Horizon Predictions</span>
            </h2>
            <p class="text-sm text-gray-400 mb-6">AI agent predictions for 1-hour and 24-hour returns</p>
            
            <!-- Current Predictions -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6" id="current-predictions">
              <!-- 1 Hour Prediction Card -->
              <div class="bg-gradient-to-br from-blue-900/50 to-purple-900/50 rounded-lg p-6 border border-blue-500/30">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold text-white">1 Hour Prediction</h3>
                  <span class="text-2xl">‚è±Ô∏è</span>
                </div>
                <div id="pred-1h-value" class="text-3xl font-bold text-blue-400 mb-2">
                  <span class="text-gray-400">Loading...</span>
                </div>
                <div id="pred-1h-confidence" class="text-sm text-gray-400 mb-4">
                  Confidence: <span class="text-gray-500">-</span>
                </div>
                <div id="pred-1h-accuracy" class="text-xs text-gray-500">
                  Accuracy: <span class="text-gray-500">-</span>
                </div>
              </div>
              
              <!-- 24 Hour Prediction Card -->
              <div class="bg-gradient-to-br from-purple-900/50 to-pink-900/50 rounded-lg p-6 border border-purple-500/30">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold text-white">24 Hour Prediction</h3>
                  <span class="text-2xl">üìÖ</span>
                </div>
                <div id="pred-24h-value" class="text-3xl font-bold text-purple-400 mb-2">
                  <span class="text-gray-400">Loading...</span>
                </div>
                <div id="pred-24h-confidence" class="text-sm text-gray-400 mb-4">
                  Confidence: <span class="text-gray-500">-</span>
                </div>
                <div id="pred-24h-accuracy" class="text-xs text-gray-500">
                  Accuracy: <span class="text-gray-500">-</span>
                </div>
              </div>
            </div>
            
            <!-- Accuracy Statistics -->
            <div class="bg-gray-700/50 rounded-lg p-4" id="accuracy-stats">
              <h4 class="text-sm font-semibold text-gray-300 mb-3">Prediction Accuracy (Last 24 Hours)</h4>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <div class="text-gray-400">1h MAE</div>
                  <div id="mae-1h" class="text-white font-bold">-</div>
                </div>
                <div>
                  <div class="text-gray-400">24h MAE</div>
                  <div id="mae-24h" class="text-white font-bold">-</div>
                </div>
                <div>
                  <div class="text-gray-400">1h RMSE</div>
                  <div id="rmse-1h" class="text-white font-bold">-</div>
                </div>
                <div>
                  <div class="text-gray-400">24h RMSE</div>
                  <div id="rmse-24h" class="text-white font-bold">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- RL Agent Attention & Influential Headlines -->
        <div class="mb-8 fade-in" id="rl-attention-section">
          <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center space-x-2">
              <span>üîç</span>
              <span>Influential News Headlines</span>
            </h2>
            <p class="text-sm text-gray-400 mb-6">Headlines that influenced the RL agent's most recent decisions</p>
            
            <!-- Recent Decisions with Headlines -->
            <div id="attention-decisions" class="space-y-4">
              <div class="text-gray-400 text-center py-8">
                <p>Loading attention data...</p>
              </div>
            </div>
            
            <!-- Cluster View Toggle -->
            <div class="mt-6 pt-4 border-t border-gray-700">
              <button 
                id="toggle-cluster-view" 
                class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium transition"
                onclick="toggleClusterView()"
              >
                View by Topic Cluster
              </button>
            </div>
            
            <!-- Cluster Statistics (hidden by default) -->
            <div id="cluster-stats" class="mt-4 hidden">
              <h4 class="text-sm font-semibold text-gray-300 mb-3">Attention by Topic Cluster</h4>
              <div id="cluster-stats-content" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>

        <!-- RL Agent Risk Dashboard -->
        <div class="mb-8 fade-in" id="rl-risk-section">
          <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center space-x-2">
              <span>üõ°Ô∏è</span>
              <span>Risk Management Dashboard</span>
            </h2>
            <p class="text-sm text-gray-400 mb-6">Real-time risk monitoring and constraint status</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="risk-metrics">
              <!-- Position Size -->
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                <div class="text-sm text-gray-400 mb-2">Position Size</div>
                <div id="position-size" class="text-2xl font-bold text-white">-</div>
                <div id="position-limit" class="text-xs text-gray-500 mt-1">Limit: -</div>
              </div>
              
              <!-- Trade Frequency -->
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                <div class="text-sm text-gray-400 mb-2">Trade Frequency</div>
                <div id="trade-frequency" class="text-2xl font-bold text-white">-</div>
                <div id="frequency-limit" class="text-xs text-gray-500 mt-1">Limit: -</div>
              </div>
              
              <!-- Daily P&L -->
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                <div class="text-sm text-gray-400 mb-2">Daily P&L</div>
                <div id="daily-pnl" class="text-2xl font-bold text-white">-</div>
                <div id="daily-loss-cap" class="text-xs text-gray-500 mt-1">Loss Cap: -</div>
              </div>
              
              <!-- Uncertainty -->
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                <div class="text-sm text-gray-400 mb-2">Uncertainty</div>
                <div id="uncertainty-metric" class="text-2xl font-bold text-white">-</div>
                <div id="uncertainty-status" class="text-xs text-gray-500 mt-1">Status: -</div>
              </div>
            </div>
          </div>
        </div>

        <!-- RL Agent Discovered Rules -->
        <div class="mb-8 fade-in" id="rl-rules-section">
          <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center space-x-2">
              <span>üß†</span>
              <span>Discovered Trading Rules</span>
            </h2>
            <p class="text-sm text-gray-400 mb-6">Human-readable rules extracted from the RL agent's learned behavior</p>
            
            <!-- Rules Table -->
            <div class="overflow-x-auto">
              <table id="rules-table" class="w-full text-sm">
                <thead>
                  <tr class="border-b border-gray-700">
                    <th class="text-left py-3 px-4 text-gray-300">Rule</th>
                    <th class="text-left py-3 px-4 text-gray-300">Action</th>
                    <th class="text-right py-3 px-4 text-gray-300">Win Rate</th>
                    <th class="text-right py-3 px-4 text-gray-300">Avg Return (1h)</th>
                    <th class="text-right py-3 px-4 text-gray-300">Avg Return (24h)</th>
                    <th class="text-right py-3 px-4 text-gray-300">Sample Size</th>
                  </tr>
                </thead>
                <tbody id="rules-tbody">
                  <tr>
                    <td colspan="6" class="text-center py-8 text-gray-400">Loading rules...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- Feature Importance -->
            <div class="mt-6 pt-4 border-t border-gray-700">
              <h4 class="text-sm font-semibold text-gray-300 mb-3">Feature Importance (SHAP)</h4>
              <div id="feature-importance" class="space-y-2">
                <div class="text-gray-400 text-sm">Loading feature importance...</div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-8 bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-white">üìä {{ selected_range|capitalize }} Price Summary</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm text-gray-200">

              <div><strong>üí∞ Current Price:</strong> ${{ stats.current_price if stats.current_price is not none else 'N/A' }}</div>
              <div><strong>üìÖ Start of Period:</strong> ${{ stats.price_start if stats.price_start is not none else 'N/A' }}</div>

              <div>
                <strong>üìà % Change ({{ selected_range|capitalize }}):</strong>
                <span class="{% if stats.percent_change is not none and stats.percent_change > 0 %}text-green-600{% elif stats.percent_change is not none and stats.percent_change < 0 %}text-red-600{% else %}text-gray-500{% endif %}">
                  {{ stats.percent_change if stats.percent_change is not none else '0' }}%
                  {% if stats.percent_change is not none and stats.percent_change > 0 %}‚¨ÜÔ∏è{% elif stats.percent_change is not none and stats.percent_change < 0 %}‚¨áÔ∏è{% else %}‚è∏Ô∏è{% endif %}
                </span>
              </div>

              <div><strong>üìà High ({{ selected_range|capitalize }}):</strong> ${{ stats.high if stats.high is not none else 'N/A' }}</div>
              <div><strong>üìâ Low ({{ selected_range|capitalize }}):</strong> ${{ stats.low if stats.low is not none else 'N/A' }}</div>
              <div><strong>üìä Range ({{ selected_range|capitalize }}):</strong> ${{ stats.range if stats.range is not none else 'N/A' }}</div>

              {# SMAs are calculated based on number of data points, might not always align with selected_range #}
              {# Keeping existing SMA labels as they describe the window of the moving average itself #}
              <div><strong>üïê SMA (1h):</strong> ${{ stats.sma_1h if stats.sma_1h is not none else 'N/A' }}</div>
              <div><strong>üïì SMA (4h):</strong> ${{ stats.sma_4h if stats.sma_4h is not none else 'N/A' }}</div>
              <div><strong>üïõ SMA (24h):</strong> ${{ stats.sma_24h if stats.sma_24h is not none else 'N/A' }}</div>

              <div>
                <strong>üìä RSI (14):</strong>
                {% if stats.rsi is not none %}
                  <span class="{% if stats.rsi > 70 %}text-red-400 font-semibold{% elif stats.rsi < 30 %}text-green-400 font-semibold{% else %}text-gray-300{% endif %}">
                    {{ "%.2f"|format(stats.rsi) }}
                    {% if stats.rsi > 70 %} (Overbought ‚ö†Ô∏è){% elif stats.rsi < 30 %} (Oversold üìà){% else %} (Neutral){% endif %}
                  </span>
                {% else %}
                  <span class="text-gray-500">N/A</span>
                {% endif %}
              </div>

              <div>
                <strong>üéØ Std Dev:</strong>
                <span class="{% if stats.std_dev is not none and stats.std_dev > 2 %}text-red-500 font-semibold{% elif stats.std_dev is not none and stats.std_dev > 1 %}text-yellow-500{% else %}text-green-600{% endif %}">
                  ${{ stats.std_dev if stats.std_dev is not none else 'N/A' }}
                  {% if stats.std_dev is not none and stats.std_dev > 2 %}‚ö†Ô∏è{% elif stats.std_dev is not none and stats.std_dev > 1 %}üìâ{% else %}üëå{% endif %}
                </span>
              </div>

              <div><strong>üìâ Avg Œî / 5min:</strong> ${{ stats.avg_delta if stats.avg_delta is not none else 'N/A' }}</div>
            </div>
          </div>




          <!-- DEPRECATED: Recent Price Predictions (Commented Out) -->
          {# Price prediction has been disabled - keeping this section commented for reference
          <div x-data="{ showAll: false }" class="mt-8 bg-white p-6 rounded-lg shadow-lg border-2 border-yellow-300">
            <h2 class="text-xl font-semibold mb-2">üß† Recent Predictions <span class="text-sm text-yellow-600 font-normal">(Deprecated - Historical Data Only)</span></h2>
            <p class="text-sm text-gray-600 mb-4 italic">Price prediction has been disabled. The data below is historical and no new predictions are being generated.</p>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm text-left text-gray-700 border">
                <thead class="bg-gray-100 text-xs uppercase font-semibold text-gray-600">
                  <tr>
                    <th class="px-4 py-2 border-b">‚è±Ô∏è Timestamp</th>
                    <th class="px-4 py-2 border-b">üîÆ Predicted</th>
                    <th class="px-4 py-2 border-b">‚úÖ Actual</th>
                    <th class="px-4 py-2 border-b">üìâ Error</th>
                    <th class="px-4 py-2 border-b relative group">
                      üìä MAE
                      <span class="ml-1 text-gray-400 cursor-help">?</span>
                      <div class="absolute z-10 hidden group-hover:block bg-white text-xs text-gray-800 border rounded shadow-md p-2 w-64 top-full left-1/2 transform -translate-x-1/2 mt-1">
                        Mean Absolute Error (MAE) is the average difference between the predicted and actual SOL price. Lower is better.
                      </div>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in predictions %}
                  <template x-if="showAll || {{ loop.index }} <= 5">
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-2 border-b">{{ p.timestamp }}</td>
                      <td class="px-4 py-2 border-b">${{ p.predicted }}</td>
                      <td class="px-4 py-2 border-b">${{ p.actual }}</td>
                      <td class="px-4 py-2 border-b text-red-600">${{ p.error }}</td>
                      <td class="px-4 py-2 border-b text-blue-600">${{ p.mae }}</td>
                    </tr>
                  </template>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="mt-4 text-center">
              <button @click="showAll = !showAll" class="text-sm text-blue-600 hover:underline focus:outline-none">
                <span x-text="showAll ? 'Show Less' : 'Show All'"></span>
              </button>
            </div>
          </div>
          #}

          <!-- Technical Indicators Summary -->
          <div class="mt-8 bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 fade-in">
            <h2 class="text-xl font-semibold mb-6 text-white">üìä Technical Indicators Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Moving Averages -->
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                <h3 class="text-sm font-semibold text-gray-300 mb-3 uppercase tracking-wide">Moving Averages</h3>
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span class="text-gray-400">SMA (1h)</span>
                    <span class="text-white font-semibold">${{ stats.sma_1h if stats.sma_1h is not none else 'N/A' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">SMA (4h)</span>
                    <span class="text-white font-semibold">${{ stats.sma_4h if stats.sma_4h is not none else 'N/A' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">SMA (24h)</span>
                    <span class="text-white font-semibold">${{ stats.sma_24h if stats.sma_24h is not none else 'N/A' }}</span>
                  </div>
                </div>
              </div>
              
              <!-- RSI Details -->
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                <h3 class="text-sm font-semibold text-gray-300 mb-3 uppercase tracking-wide">RSI Analysis</h3>
                <div class="space-y-2">
                  {% if stats.rsi is not none %}
                    <div class="flex justify-between">
                      <span class="text-gray-400">RSI (14)</span>
                      <span class="{% if stats.rsi > 70 %}text-red-400{% elif stats.rsi < 30 %}text-green-400{% else %}text-gray-300{% endif %} font-semibold">
                        {{ "%.2f"|format(stats.rsi) }}
                      </span>
                    </div>
                    <div class="mt-3">
                      {% if stats.rsi > 70 %}
                        <div class="text-xs text-red-300 bg-red-900/30 px-2 py-1 rounded">Overbought Zone</div>
                      {% elif stats.rsi < 30 %}
                        <div class="text-xs text-green-300 bg-green-900/30 px-2 py-1 rounded">Oversold Zone</div>
                      {% else %}
                        <div class="text-xs text-gray-400 bg-gray-600/30 px-2 py-1 rounded">Neutral Zone</div>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="text-gray-500">Insufficient data</div>
                  {% endif %}
                </div>
              </div>
              
              <!-- Volatility -->
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                <h3 class="text-sm font-semibold text-gray-300 mb-3 uppercase tracking-wide">Volatility</h3>
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span class="text-gray-400">Std Dev</span>
                    <span class="{% if stats.std_dev is not none and stats.std_dev > 2 %}text-red-400{% elif stats.std_dev is not none and stats.std_dev > 1 %}text-yellow-400{% else %}text-green-400{% endif %} font-semibold">
                      ${{ stats.std_dev if stats.std_dev is not none else 'N/A' }}
                    </span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">Avg Œî / 5min</span>
                    <span class="text-white font-semibold">${{ stats.avg_delta if stats.avg_delta is not none else 'N/A' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

    </div>


    <script>
      // Wait for TradingView library to load
      function initChart() {
      console.log('=== Chart Initialization Started ===');
      
      // Data from Flask
      const timestamps = {{ timestamps|tojson }};
      const prices = {{ prices|tojson }};
      const rsiValues = {{ rsi_values|tojson }};
      const unixTimestamps = {{ unix_timestamps|tojson }};
      
      console.log('Data received from server:', {
          timestamps: timestamps ? timestamps.length : 0,
          prices: prices ? prices.length : 0,
          rsiValues: rsiValues ? rsiValues.length : 0,
          unixTimestamps: unixTimestamps ? unixTimestamps.length : 0
      });

      // Debug: Log data to console
      console.log('Timestamps:', timestamps ? timestamps.length : 0);
      console.log('Prices:', prices ? prices.length : 0);
      console.log('Unix Timestamps:', unixTimestamps ? unixTimestamps.length : 0);
      console.log('Unix Timestamps type:', typeof unixTimestamps);
      console.log('Unix Timestamps value:', unixTimestamps);
      if (timestamps && timestamps.length > 0) {
          console.log('Sample data:', {
              firstTimestamp: timestamps[0],
              firstPrice: prices[0],
              firstUnix: unixTimestamps && unixTimestamps.length > 0 ? unixTimestamps[0] : 'undefined'
          });
      }

      // Prepare price data for TradingView (using Unix timestamps from server)
      const priceData = [];
      const timestampToIndex = {};
      
      if (timestamps.length !== prices.length || timestamps.length !== unixTimestamps.length) {
          console.error('Data length mismatch!', {
              timestamps: timestamps.length,
              prices: prices.length,
              unixTimestamps: unixTimestamps.length
          });
      }
      
      // Check if we have valid data
      if (!unixTimestamps || unixTimestamps.length === 0) {
          console.warn('WARNING: unixTimestamps is empty! Generating from formatted timestamps as fallback.');
          // Fallback: Generate Unix timestamps from formatted timestamps
          // This is less ideal but will work if server-side generation failed
          unixTimestamps = [];
          timestamps.forEach((ts, i) => {
              try {
                  // Parse "Nov 26, 06:38 PM" format
                  const date = new Date(ts);
                  if (!isNaN(date.getTime())) {
                      unixTimestamps.push(Math.floor(date.getTime() / 1000));
                  } else {
                      // If parsing fails, use current time as fallback (not ideal but prevents crash)
                      console.warn(`Failed to parse timestamp: ${ts}, using current time`);
                      unixTimestamps.push(Math.floor(Date.now() / 1000));
                  }
              } catch (e) {
                  console.error(`Error parsing timestamp ${ts}:`, e);
                  unixTimestamps.push(Math.floor(Date.now() / 1000));
              }
          });
          console.log('Generated', unixTimestamps.length, 'Unix timestamps as fallback');
      }
      
      if (timestamps && prices && unixTimestamps) {
          timestamps.forEach((ts, i) => {
              const unixTime = unixTimestamps[i];
              const price = prices[i];
              
              if (unixTime && unixTime !== null && unixTime !== undefined && !isNaN(unixTime) && 
                  price !== undefined && price !== null && !isNaN(price) && isFinite(price) && price > 0) {
                  priceData.push({
                      time: unixTime,
                      value: price
                  });
                  timestampToIndex[ts] = i;
              }
          });
      } else {
          console.error('Missing required data arrays:', {
              hasTimestamps: !!timestamps,
              hasPrices: !!prices,
              hasUnixTimestamps: !!unixTimestamps
          });
      }

      console.log('Price data prepared:', priceData.length, 'points');
      if (priceData.length > 0) {
          console.log('First price point:', priceData[0]);
          console.log('Last price point:', priceData[priceData.length - 1]);
          
          // Validate data format for TradingView
          const invalidPoints = [];
          priceData.forEach((point, idx) => {
              if (!point || typeof point.time !== 'number' || typeof point.value !== 'number') {
                  invalidPoints.push({idx, point});
              }
              if (point && (isNaN(point.time) || isNaN(point.value) || point.value <= 0)) {
                  invalidPoints.push({idx, point, reason: 'NaN or invalid value'});
              }
              // Check if timestamp is reasonable (not too far in past/future)
              if (point && point.time) {
                  const now = Math.floor(Date.now() / 1000);
                  const yearAgo = now - (365 * 24 * 60 * 60);
                  const yearFromNow = now + (365 * 24 * 60 * 60);
                  if (point.time < yearAgo || point.time > yearFromNow) {
                      invalidPoints.push({idx, point, reason: `Timestamp out of range: ${point.time} (now: ${now})`});
                  }
              }
          });
          if (invalidPoints.length > 0) {
              console.error('Invalid price data points found:', invalidPoints.slice(0, 10));
          } else {
              console.log('‚úÖ All price data points are valid');
          }
      } else {
          console.error('‚ùå No price data to display!');
      }

      // Create RSI-based signal markers
      const buyMarkers = [];
      const sellMarkers = [];
      
      // Add markers based on RSI values (oversold = buy, overbought = sell)
      // Note: RSI values may have fewer points than price data (RSI needs history to calculate)
      if (rsiValues && unixTimestamps && prices && priceData.length > 0) {
          // Create a map of time -> price index for faster lookup
          const timeToPriceIndex = {};
          priceData.forEach((point, idx) => {
              if (point.time && point.value !== null && point.value !== undefined) {
                  timeToPriceIndex[point.time] = idx;
              }
          });
          
          // Iterate through RSI values and match them to price data by time
          rsiValues.forEach((rsi, rsiIndex) => {
              // Skip null/undefined RSI values
              if (rsi === null || rsi === undefined || isNaN(rsi)) {
                  return;
              }
              
              // Find corresponding timestamp - RSI index might be offset from price index
              // Try to find matching timestamp in priceData
              let matchedTime = null;
              
              // Strategy 1: If RSI index is within unixTimestamps bounds, use that
              if (rsiIndex < unixTimestamps.length && unixTimestamps[rsiIndex] !== null && unixTimestamps[rsiIndex] !== undefined) {
                  const candidateTime = unixTimestamps[rsiIndex];
                  // Verify this time exists in priceData
                  if (timeToPriceIndex.hasOwnProperty(candidateTime)) {
                      matchedTime = candidateTime;
                  }
              }
              
              // Strategy 2: If no direct match, try to find closest timestamp in priceData
              // (RSI typically starts after some price history is available)
              if (!matchedTime && priceData.length > 0) {
                  // RSI usually starts at index ~14 (for 14-period RSI), so offset the index
                  const estimatedPriceIndex = Math.min(rsiIndex + 14, priceData.length - 1);
                  if (priceData[estimatedPriceIndex] && priceData[estimatedPriceIndex].time) {
                      matchedTime = priceData[estimatedPriceIndex].time;
                  }
              }
              
              // Only create marker if we found a valid time
              if (matchedTime && matchedTime !== null && matchedTime !== undefined) {
                  // Buy signal: RSI < 30 (oversold)
                  if (rsi < 30) {
                      buyMarkers.push({
                          time: matchedTime,
                          position: 'belowBar',
                          color: '#10b981',
                          shape: 'arrowUp',
                          text: 'BUY',
                          size: 1
                      });
                  }
                  // Sell signal: RSI > 70 (overbought)
                  else if (rsi > 70) {
                      sellMarkers.push({
                          time: matchedTime,
                          position: 'aboveBar',
                          color: '#ef4444',
                          shape: 'arrowDown',
                          text: 'SELL',
                          size: 1
                      });
                  }
              }
          });
      }

      // Prepare RSI data
      // RSI values may have fewer points than price data (RSI needs history to calculate)
      // CRITICAL: Only include RSI points where timestamp exactly matches price data timestamp
      const rsiData = [];
      if (rsiValues && priceData && priceData.length > 0) {
          // Create a Set of valid price timestamps for fast lookup
          const validPriceTimes = new Set();
          priceData.forEach((point) => {
              if (point && point.time !== null && point.time !== undefined && !isNaN(point.time) && isFinite(point.time)) {
                  validPriceTimes.add(point.time);
              }
          });
          
          console.log('Valid price timestamps:', validPriceTimes.size);
          
          // RSI typically starts after some price history (e.g., 14 periods for 14-period RSI)
          // Match RSI values to price data timestamps - ONLY use timestamps that exist in priceData
          rsiValues.forEach((rsi, rsiIndex) => {
              // Skip invalid RSI values
              if (rsi === null || rsi === undefined || isNaN(rsi) || !isFinite(rsi) || rsi < 0 || rsi > 100) {
                  return;
              }
              
              // Find corresponding timestamp - must exist in priceData
              let matchedTime = null;
              
              // Strategy 1: If unixTimestamps available, try matching by index
              if (unixTimestamps && rsiIndex < unixTimestamps.length) {
                  const candidateTime = unixTimestamps[rsiIndex];
                  // CRITICAL: Only use if this timestamp exists in priceData
                  if (candidateTime && !isNaN(candidateTime) && isFinite(candidateTime) && validPriceTimes.has(candidateTime)) {
                      matchedTime = candidateTime;
                  }
              }
              
              // Strategy 2: Try index offset (RSI usually starts at index ~14)
              if (!matchedTime) {
                  const estimatedPriceIndex = Math.min(rsiIndex + 14, priceData.length - 1);
                  if (priceData[estimatedPriceIndex] && priceData[estimatedPriceIndex].time) {
                      const candidateTime = priceData[estimatedPriceIndex].time;
                      // CRITICAL: Verify this timestamp is valid
                      if (candidateTime && !isNaN(candidateTime) && isFinite(candidateTime) && validPriceTimes.has(candidateTime)) {
                          matchedTime = candidateTime;
                      }
                  }
              }
              
              // Only add if we found a valid timestamp that exists in priceData
              if (matchedTime && validPriceTimes.has(matchedTime)) {
                  rsiData.push({
                      time: matchedTime,
                      value: rsi
                  });
              }
          });
          
          // CRITICAL: Sort RSI data by time (TradingView requirement)
          rsiData.sort((a, b) => a.time - b.time);
          
          // Remove duplicates (same timestamp)
          const seen = new Set();
          const uniqueRsiData = [];
          rsiData.forEach(point => {
              if (!seen.has(point.time)) {
                  seen.add(point.time);
                  uniqueRsiData.push(point);
              }
          });
          
          // Replace rsiData with deduplicated version
          rsiData.length = 0;
          rsiData.push(...uniqueRsiData);
      }
      
      console.log('RSI data prepared:', rsiData.length, 'points (all timestamps verified against price data)');

      // Professional Dark Theme Configuration
      const chartOptions = {
          layout: {
              background: { color: '#1a1a1a' },
              textColor: '#d1d5db',
          },
          grid: {
              vertLines: { color: '#2a2a2a', style: 1 },
              horzLines: { color: '#2a2a2a', style: 1 },
          },
          crosshair: {
              mode: 1,
              vertLine: {
                  color: '#6b7280',
                  width: 1,
                  style: 3,
              },
              horzLine: {
                  color: '#6b7280',
                  width: 1,
                  style: 3,
              },
          },
          rightPriceScale: {
              borderColor: '#2a2a2a',
              scaleMargins: {
                  top: 0.1,
                  bottom: 0.1,
              },
          },
          timeScale: {
              borderColor: '#2a2a2a',
              timeVisible: true,
              secondsVisible: false,
          },
      };

      // Create main price chart
      const chartContainer = document.getElementById('tradingview-chart');
      
      if (!chartContainer) {
          console.error('‚ùå Chart container "tradingview-chart" not found!');
          console.error('Available elements with "chart" in ID:', 
              Array.from(document.querySelectorAll('[id*="chart"]')).map(el => el.id));
          return;
      }
      
      // Check container dimensions
      const containerWidth = chartContainer.clientWidth || chartContainer.offsetWidth;
      const containerHeight = chartContainer.clientHeight || chartContainer.offsetHeight;
      console.log('Chart container dimensions:', { 
          width: containerWidth, 
          height: containerHeight,
          computedWidth: window.getComputedStyle(chartContainer).width,
          computedHeight: window.getComputedStyle(chartContainer).height
      });
      
      if (containerWidth === 0 || containerHeight === 0) {
          console.warn('‚ö†Ô∏è Chart container has zero dimensions, setting defaults');
          chartContainer.style.width = chartContainer.style.width || '100%';
          chartContainer.style.height = chartContainer.style.height || '500px';
          console.log('Updated dimensions:', {
              width: chartContainer.clientWidth,
              height: chartContainer.clientHeight
          });
      }
      
      if (typeof LightweightCharts === 'undefined') {
          console.error('‚ùå TradingView Lightweight Charts library not loaded!');
          chartContainer.innerHTML = '<div class="text-white p-4 text-center">Chart library failed to load. Please refresh the page.</div>';
          return;
      }
      console.log('‚úÖ TradingView LightweightCharts library loaded');
      
      if (priceData.length === 0) {
          console.error('No price data available!');
          console.error('Debug info:', {
              timestampsLength: timestamps ? timestamps.length : 0,
              pricesLength: prices ? prices.length : 0,
              unixTimestampsLength: unixTimestamps ? unixTimestamps.length : 0,
              unixTimestampsType: typeof unixTimestamps,
              unixTimestampsValue: unixTimestamps
          });
          chartContainer.innerHTML = '<div class="text-white p-4 text-center">No price data available for the selected time range. Check console for details.</div>';
      } else {
          let chart, priceSeries, rsiChart, rsiSeries;
          
          try {
              console.log('Creating chart with', priceData.length, 'data points');
              console.log('LightweightCharts object:', typeof LightweightCharts, LightweightCharts);
              
              // Check if createChart exists
              if (!LightweightCharts || !LightweightCharts.createChart) {
                  throw new Error('LightweightCharts.createChart is not available. Library may not have loaded correctly.');
              }
              
              chart = LightweightCharts.createChart(chartContainer, {
                  ...chartOptions,
                  width: chartContainer.clientWidth,
                  height: 500,
              });

              console.log('Chart created:', chart);
              console.log('Chart methods:', Object.keys(chart).filter(k => k.includes('Series')));
              
              // Check if addLineSeries exists, if not try addSeries (v5.x API)
              if (typeof chart.addLineSeries === 'function') {
                  // v4.x API
                  priceSeries = chart.addLineSeries({
                      color: '#3b82f6',
                      lineWidth: 2,
                      priceFormat: {
                          type: 'price',
                          precision: 2,
                          minMove: 0.01,
                      },
                      lastValueVisible: true,
                      priceLineVisible: true,
                  });
              } else if (typeof chart.addSeries === 'function' && LightweightCharts.LineSeries) {
                  // v5.x API
                  priceSeries = chart.addSeries(LightweightCharts.LineSeries, {
                      color: '#3b82f6',
                      lineWidth: 2,
                      priceFormat: {
                          type: 'price',
                          precision: 2,
                          minMove: 0.01,
                      },
                      lastValueVisible: true,
                      priceLineVisible: true,
                  });
              } else {
                  throw new Error('Neither addLineSeries nor addSeries(LineSeries) is available. Chart library version issue.');
              }

              // Final validation: filter out any null/invalid values (declare at higher scope)
              let validPriceData = [];
              let finalPriceData = []; // Declare at higher scope for use in markers and crosshair
              if (priceData.length > 0) {
                  validPriceData = priceData.filter(point => {
                      return point && 
                             point.time !== null && point.time !== undefined && !isNaN(point.time) &&
                             point.value !== null && point.value !== undefined && !isNaN(point.value) && isFinite(point.value) && point.value > 0;
                  });
                  if (validPriceData.length > 0) {
                      // Final validation: ensure data is sorted by time (TradingView requirement)
                      validPriceData.sort((a, b) => a.time - b.time);
                      
                      // Remove duplicate timestamps (keep the last one for each timestamp)
                      const seen = new Map();
                      const deduplicatedPriceData = [];
                      for (let i = validPriceData.length - 1; i >= 0; i--) {
                          const point = validPriceData[i];
                          if (!seen.has(point.time)) {
                              seen.set(point.time, point);
                              deduplicatedPriceData.unshift(point);
                          }
                      }
                      validPriceData.length = 0;
                      validPriceData.push(...deduplicatedPriceData);
                      
                      // Log sample data for debugging
                      console.log('Sample valid price data (first 3):', validPriceData.slice(0, 3));
                      console.log('Sample valid price data (last 3):', validPriceData.slice(-3));
                      console.log('Time range:', {
                          first: new Date(validPriceData[0].time * 1000).toISOString(),
                          last: new Date(validPriceData[validPriceData.length - 1].time * 1000).toISOString(),
                          span_hours: (validPriceData[validPriceData.length - 1].time - validPriceData[0].time) / 3600
                      });
                      
                      // Final check: ensure no null/undefined values
                      finalPriceData = validPriceData.filter(point => {
                          return point && 
                                 point.time !== null && point.time !== undefined && !isNaN(point.time) && isFinite(point.time) &&
                                 point.value !== null && point.value !== undefined && !isNaN(point.value) && isFinite(point.value) && point.value > 0;
                      });
                      
                      if (finalPriceData.length !== validPriceData.length) {
                          console.warn(`Filtered out ${validPriceData.length - finalPriceData.length} invalid price points`);
                      }
                      
                      try {
                          priceSeries.setData(finalPriceData);
                          console.log('‚úÖ Price data set successfully:', finalPriceData.length, 'points (filtered from', priceData.length, ')');
                          
                          // Fit content to show all data
                          try {
                              chart.timeScale().fitContent();
                              console.log('‚úÖ Chart time scale fitted to content');
                          } catch (fitError) {
                              console.warn('Could not fit content:', fitError);
                          }
                          
                          // Verify data was actually set
                          setTimeout(() => {
                              try {
                                  // Try to get the visible time range to verify chart has data
                                  const visibleRange = chart.timeScale().getVisibleRange();
                                  if (visibleRange) {
                                      console.log('‚úÖ Chart has visible time range:', {
                                          from: new Date(visibleRange.from * 1000).toISOString(),
                                          to: new Date(visibleRange.to * 1000).toISOString()
                                      });
                                  } else {
                                      console.warn('‚ö†Ô∏è Chart time scale not initialized - trying to set visible range manually');
                                      // Try to set visible range manually
                                      if (finalPriceData.length > 0) {
                                          const firstTime = finalPriceData[0].time;
                                          const lastTime = finalPriceData[finalPriceData.length - 1].time;
                                          chart.timeScale().setVisibleRange({
                                              from: firstTime,
                                              to: lastTime
                                          });
                                          console.log('‚úÖ Manually set visible range');
                                      }
                                  }
                              } catch (e) {
                                  console.warn('Could not verify chart time scale:', e);
                              }
                          }, 200);
                      } catch (e) {
                          console.error('‚ùå Error setting price data:', e);
                          console.error('Error details:', e.message, e.stack);
                          // Try to find which point is causing the issue
                          validPriceData.forEach((point, idx) => {
                              if (!point || point.time === null || point.value === null || isNaN(point.time) || isNaN(point.value)) {
                                  console.error('Invalid price point at index', idx, ':', point);
                              }
                          });
                          chartContainer.innerHTML = '<div class="text-white p-4 text-center">Error loading price data. Check console for details.</div>';
                          return;
                      }
                  } else {
                      console.error('‚ùå No valid price data to display (all points filtered out)');
                      console.error('Original priceData length:', priceData.length);
                      console.error('Sample of filtered out data:', priceData.slice(0, 5));
                      chartContainer.innerHTML = '<div class="text-white p-4 text-center">No valid price data available for the selected time range.</div>';
                      return;
                  }

                  // Add markers for buy/sell/hold signals
                  // Filter out any markers with null/invalid time values AND ensure time exists in price data
                  const priceDataTimes = new Set(finalPriceData.map(p => p.time));
                  const validMarkers = [...buyMarkers, ...sellMarkers].filter(marker => {
                      if (!marker || 
                          marker.time === null || marker.time === undefined || 
                          isNaN(marker.time) || !isFinite(marker.time)) {
                          return false;
                      }
                      // CRITICAL: Ensure the marker's time exists in the price data
                      if (!priceDataTimes.has(marker.time)) {
                          return false;
                      }
                      return true;
                  });
                  if (validMarkers.length > 0) {
                      try {
                          priceSeries.setMarkers(validMarkers);
                          console.log('‚úÖ RSI-based markers set:', validMarkers.length, '(Buy:', buyMarkers.filter(m => m && priceDataTimes.has(m.time)).length, 'Sell:', sellMarkers.filter(m => m && priceDataTimes.has(m.time)).length, ')');
                      } catch (e) {
                          console.error('‚ùå Error setting markers:', e);
                          console.error('Error details:', e.message, e.stack);
                          // Don't break the chart if markers fail - just log the error
                      }
                  } else {
                      console.warn('‚ö†Ô∏è No valid markers to set (all markers filtered out due to null/invalid time values or missing price data)');
                  }
              } else {
                  console.error('No price data to display!');
                  // Show error message
                  chartContainer.innerHTML = '<div class="text-white p-4 text-center">No price data available for the selected time range.</div>';
                  return;
              }

              // Update price display on crosshair move
              // Store first price from filtered data for comparison
              const firstValidPrice = finalPriceData.length > 0 ? finalPriceData[0].value : null;
              
              chart.subscribeCrosshairMove(param => {
                  try {
                      if (param === null || param === undefined || param.point === undefined || !param.time || !param.seriesData || param.seriesData.size === 0) {
                          return;
                      }
                      const price = param.seriesData.get(priceSeries);
                      if (price && price.value !== null && price.value !== undefined && !isNaN(price.value) && isFinite(price.value)) {
                          const currentPrice = price.value;
                          if (firstValidPrice !== null && firstValidPrice !== undefined && !isNaN(firstValidPrice) && isFinite(firstValidPrice)) {
                              const change = currentPrice - firstValidPrice;
                              const changePercent = ((change / firstValidPrice) * 100).toFixed(2);
                              
                              const priceEl = document.getElementById('chart-price');
                              const changeEl = document.getElementById('chart-change');
                              if (priceEl) {
                                  priceEl.textContent = `$${currentPrice.toFixed(2)}`;
                              }
                              if (changeEl) {
                                  changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent}%)`;
                                  changeEl.className = change >= 0 ? 'ml-2 text-green-400' : 'ml-2 text-red-400';
                              }
                          }
                      }
                  } catch (e) {
                      // Silently ignore crosshair errors to prevent console spam
                      // console.debug('Crosshair update error:', e);
                  }
              });

              // Create RSI chart below
              const rsiChartContainer = document.getElementById('rsi-chart');
              if (rsiChartContainer) {
                  rsiChart = LightweightCharts.createChart(rsiChartContainer, {
                      ...chartOptions,
                      height: 150,
                      rightPriceScale: {
                          ...chartOptions.rightPriceScale,
                          visible: true,
                          scaleMargins: {
                              top: 0.1,
                              bottom: 0.1,
                          },
                      },
                  });

                  // Check API version for RSI series
                  if (typeof rsiChart.addLineSeries === 'function') {
                      // v4.x API
                      rsiSeries = rsiChart.addLineSeries({
                          color: '#d97706',
                          lineWidth: 1,
                          priceFormat: {
                              type: 'price',
                              precision: 2,
                              minMove: 0.01,
                          },
                      });
                  } else if (typeof rsiChart.addSeries === 'function' && LightweightCharts.LineSeries) {
                      // v5.x API
                      rsiSeries = rsiChart.addSeries(LightweightCharts.LineSeries, {
                          color: '#d97706',
                          lineWidth: 1,
                          priceFormat: {
                              type: 'price',
                              precision: 2,
                              minMove: 0.01,
                          },
                      });
                  } else {
                      console.error('Cannot create RSI series - API not available');
                      rsiSeries = null;
                  }
                  
                  if (rsiSeries && rsiData.length > 0) {
                      // Final validation: filter out any null/invalid values AND ensure timestamps exist in price data
                      const validPriceTimesSet = new Set(validPriceData.map(p => p.time));
                      const validRsiData = rsiData.filter(point => {
                          if (!point || 
                              point.time === null || point.time === undefined || isNaN(point.time) || !isFinite(point.time) ||
                              point.value === null || point.value === undefined || isNaN(point.value) || !isFinite(point.value) ||
                              point.value < 0 || point.value > 100) {
                              return false;
                          }
                          // CRITICAL: Only include if timestamp exists in price data
                          return validPriceTimesSet.has(point.time);
                      });
                      
                      // Sort by time (required by TradingView)
                      validRsiData.sort((a, b) => a.time - b.time);
                      
                      if (validRsiData.length > 0) {
                          try {
                              rsiSeries.setData(validRsiData);
                              console.log('‚úÖ RSI data set successfully:', validRsiData.length, 'points (filtered from', rsiData.length, ')');
                              console.log('RSI time range:', {
                                  first: new Date(validRsiData[0].time * 1000).toISOString(),
                                  last: new Date(validRsiData[validRsiData.length - 1].time * 1000).toISOString()
                              });
                          } catch (e) {
                              console.error('‚ùå Error setting RSI data:', e);
                              console.error('Error details:', e.message, e.stack);
                              // Don't break the chart if RSI fails - just log the error
                          }
                      } else {
                          console.warn('‚ö†Ô∏è No valid RSI data to display (all points filtered out or timestamps don\'t match price data)');
                      }

                      // Add RSI overbought/oversold lines (only if RSI data was set successfully)
                      if (validRsiData.length > 0) {
                          try {
                              rsiSeries.createPriceLine({
                                  price: 70,
                                  color: '#ef4444',
                                  lineWidth: 1,
                                  lineStyle: 2,
                                  axisLabelVisible: true,
                                  title: 'Overbought',
                              });

                              rsiSeries.createPriceLine({
                                  price: 30,
                                  color: '#10b981',
                                  lineWidth: 1,
                                  lineStyle: 2,
                                  axisLabelVisible: true,
                                  title: 'Oversold',
                              });
                          } catch (e) {
                              console.error('Error creating RSI price lines:', e);
                          }
                      }
                  } else {
                      console.warn('No RSI data available');
                  }

                  // Synchronize crosshair between charts
                  if (chart && rsiChart && rsiSeries) {
                      chart.subscribeCrosshairMove(param => {
                          if (param.time && rsiChart) {
                              rsiChart.setCrosshairPosition(param.time, param.point);
                          }
                      });

                      rsiChart.subscribeCrosshairMove(param => {
                          if (param.time && chart) {
                              chart.setCrosshairPosition(param.time, param.point);
                          }
                      });

                      // Handle window resize
                      window.addEventListener('resize', () => {
                          if (chart) chart.applyOptions({ width: chartContainer.clientWidth });
                          if (rsiChart) rsiChart.applyOptions({ width: rsiChartContainer.clientWidth });
                      });
                  }
              } // Close rsiChartContainer if block
          } catch (error) {
              console.error('Error creating chart:', error);
              chartContainer.innerHTML = '<div class="text-white p-4 text-center">Error creating chart: ' + error.message + '</div>';
          }
      } // Close else block (priceData.length > 0)

      // Set initial price display
      if (prices && prices.length > 0) {
          const lastPrice = prices[prices.length - 1];
          const firstPrice = prices[0];
          const change = lastPrice - firstPrice;
          const changePercent = firstPrice > 0 ? ((change / firstPrice) * 100).toFixed(2) : '0.00';
          
          const priceEl = document.getElementById('chart-price');
          const changeEl = document.getElementById('chart-change');
          
          if (priceEl) {
              priceEl.textContent = `$${lastPrice.toFixed(2)}`;
          }
          
          if (changeEl) {
              changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent}%)`;
              changeEl.className = change >= 0 ? 'ml-2 text-green-400' : 'ml-2 text-red-400';
          }
      } else {
          console.warn('No prices available for display');
          const priceEl = document.getElementById('chart-price');
          if (priceEl) {
              priceEl.textContent = 'No Data';
          }
      }
      } // End initChart function
      
      // Wait for library to load, then initialize chart
      if (typeof LightweightCharts !== 'undefined') {
          initChart();
      } else {
          // Wait for library to load
          window.addEventListener('load', function() {
              if (typeof LightweightCharts !== 'undefined') {
                  initChart();
              } else {
                  console.error('TradingView Lightweight Charts failed to load');
                  const chartContainer = document.getElementById('tradingview-chart');
                  if (chartContainer) {
                      chartContainer.innerHTML = '<div class="text-white p-4 text-center">Chart library failed to load. Please refresh the page.</div>';
                  }
              }
          });
      }

      // RL Agent Predictions
      async function updateRLPredictions() {
          try {
              const response = await fetch('/api/rl-agent/predictions?limit=1&hours=24');
              const data = await response.json();
              
              if (data.success && data.current_prediction) {
                  const pred = data.current_prediction;
                  
                  // Update 1h prediction
                  const pred1hEl = document.getElementById('pred-1h-value');
                  if (pred1hEl && pred.predicted_return_1h !== null) {
                      const value = (pred.predicted_return_1h * 100).toFixed(2);
                      const color = pred.predicted_return_1h >= 0 ? 'text-green-400' : 'text-red-400';
                      pred1hEl.innerHTML = `<span class="${color}">${pred.predicted_return_1h >= 0 ? '+' : ''}${value}%</span>`;
                  }
                  
                  const conf1hEl = document.getElementById('pred-1h-confidence');
                  if (conf1hEl) {
                      const conf = pred.predicted_confidence_1h !== null ? (pred.predicted_confidence_1h * 100).toFixed(1) : 'N/A';
                      conf1hEl.innerHTML = `Confidence: <span class="text-gray-300">${conf}%</span>`;
                  }
                  
                  // Update 24h prediction
                  const pred24hEl = document.getElementById('pred-24h-value');
                  if (pred24hEl && pred.predicted_return_24h !== null) {
                      const value = (pred.predicted_return_24h * 100).toFixed(2);
                      const color = pred.predicted_return_24h >= 0 ? 'text-green-400' : 'text-red-400';
                      pred24hEl.innerHTML = `<span class="${color}">${pred.predicted_return_24h >= 0 ? '+' : ''}${value}%</span>`;
                  }
                  
                  const conf24hEl = document.getElementById('pred-24h-confidence');
                  if (conf24hEl) {
                      const conf = pred.predicted_confidence_24h !== null ? (pred.predicted_confidence_24h * 100).toFixed(1) : 'N/A';
                      conf24hEl.innerHTML = `Confidence: <span class="text-gray-300">${conf}%</span>`;
                  }
                  
                  // Update accuracy stats
                  if (data.accuracy_stats) {
                      const stats = data.accuracy_stats;
                      document.getElementById('mae-1h').textContent = stats.mae_1h > 0 ? (stats.mae_1h * 100).toFixed(2) + '%' : '-';
                      document.getElementById('mae-24h').textContent = stats.mae_24h > 0 ? (stats.mae_24h * 100).toFixed(2) + '%' : '-';
                      document.getElementById('rmse-1h').textContent = stats.rmse_1h > 0 ? (stats.rmse_1h * 100).toFixed(2) + '%' : '-';
                      document.getElementById('rmse-24h').textContent = stats.rmse_24h > 0 ? (stats.rmse_24h * 100).toFixed(2) + '%' : '-';
                  }
              } else {
                  // No predictions available yet
                  document.getElementById('pred-1h-value').innerHTML = '<span class="text-gray-400">No prediction yet</span>';
                  document.getElementById('pred-24h-value').innerHTML = '<span class="text-gray-400">No prediction yet</span>';
              }
          } catch (error) {
              console.error('Error fetching RL predictions:', error);
              // Hide section if RL agent not available
              const section = document.getElementById('rl-predictions-section');
              if (section) {
                  section.style.display = 'none';
              }
          }
      }
      
      // Load predictions on page load
      updateRLPredictions();
      
      // Refresh predictions every 5 minutes
      setInterval(updateRLPredictions, 5 * 60 * 1000);

      // RL Agent Attention
      async function updateRLAttention() {
          try {
              const response = await fetch('/api/rl-agent/attention?limit=5');
              const data = await response.json();
              
              if (data.success && data.recent_decisions) {
                  const container = document.getElementById('attention-decisions');
                  if (!container) return;
                  
                  if (data.recent_decisions.length === 0) {
                      container.innerHTML = '<div class="text-gray-400 text-center py-8"><p>No attention data available yet</p></div>';
                      return;
                  }
                  
                  let html = '';
                  data.recent_decisions.forEach(decision => {
                      const actionColors = {
                          'BUY': 'text-green-400',
                          'SELL': 'text-red-400',
                          'HOLD': 'text-yellow-400'
                      };
                      const actionColor = actionColors[decision.action] || 'text-gray-400';
                      
                      html += `
                        <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                          <div class="flex items-center justify-between mb-3">
                            <div>
                              <span class="text-sm font-semibold ${actionColor}">${decision.action}</span>
                              <span class="text-xs text-gray-400 ml-2">${new Date(decision.timestamp).toLocaleString()}</span>
                            </div>
                          </div>
                          ${decision.headlines && decision.headlines.length > 0 ? `
                            <div class="space-y-2">
                              <div class="text-xs text-gray-400 mb-2">Top Influential Headlines:</div>
                              ${decision.headlines.map(h => `
                                <div class="flex items-start justify-between bg-gray-800/50 rounded p-2">
                                  <span class="text-sm text-gray-300 flex-1">${h.headline_text || 'N/A'}</span>
                                  <span class="text-xs text-purple-400 ml-2">${(h.attention_weight * 100).toFixed(1)}%</span>
                                </div>
                              `).join('')}
                            </div>
                          ` : '<div class="text-xs text-gray-500">No headlines available</div>'}
                        </div>
                      `;
                  });
                  
                  container.innerHTML = html;
              } else {
                  // Hide section if no data
                  const section = document.getElementById('rl-attention-section');
                  if (section) {
                      section.style.display = 'none';
                  }
              }
          } catch (error) {
              console.error('Error fetching RL attention:', error);
              // Hide section on error
              const section = document.getElementById('rl-attention-section');
              if (section) {
                  section.style.display = 'none';
              }
          }
      }
      
      async function toggleClusterView() {
          const clusterStats = document.getElementById('cluster-stats');
          const button = document.getElementById('toggle-cluster-view');
          
          if (clusterStats.classList.contains('hidden')) {
              // Show cluster view
              try {
                  const response = await fetch('/api/rl-agent/attention?cluster=true&hours=24');
                  const data = await response.json();
                  
                  if (data.success && data.cluster_stats) {
                      const content = document.getElementById('cluster-stats-content');
                      let html = '';
                      
                      Object.values(data.cluster_stats).forEach(cluster => {
                          html += `
                            <div class="bg-gray-700/50 rounded-lg p-3 border border-gray-600">
                              <div class="text-sm font-semibold text-gray-300 mb-2">Cluster ${cluster.cluster_id}</div>
                              <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                  <span class="text-gray-400">Avg Attention:</span>
                                  <span class="text-white">${(cluster.avg_attention * 100).toFixed(2)}%</span>
                                </div>
                                <div class="flex justify-between">
                                  <span class="text-gray-400">Total Weight:</span>
                                  <span class="text-white">${(cluster.total_attention * 100).toFixed(2)}%</span>
                                </div>
                                <div class="flex justify-between">
                                  <span class="text-gray-400">Headlines:</span>
                                  <span class="text-white">${cluster.count}</span>
                                </div>
                              </div>
                            </div>
                          `;
                      });
                      
                      content.innerHTML = html || '<div class="text-gray-400 text-sm">No cluster data available</div>';
                      clusterStats.classList.remove('hidden');
                      button.textContent = 'View by Decision';
                  }
              } catch (error) {
                  console.error('Error fetching cluster stats:', error);
              }
          } else {
              // Hide cluster view
              clusterStats.classList.add('hidden');
              button.textContent = 'View by Topic Cluster';
          }
      }
      
      // Load attention on page load
      updateRLAttention();
      
      // Refresh attention every 5 minutes
      setInterval(updateRLAttention, 5 * 60 * 1000);

      // RL Agent Risk Dashboard
      async function updateRLRisk() {
          try {
              const response = await fetch('/api/rl-agent/risk');
              const data = await response.json();
              
              if (data.success && data.risk_metrics) {
                  const metrics = data.risk_metrics;
                  
                  // Update position size
                  const posEl = document.getElementById('position-size');
                  if (posEl) {
                      posEl.textContent = `${(metrics.max_position_size * 100).toFixed(1)}%`;
                  }
                  
                  // Update trade frequency
                  const freqEl = document.getElementById('trade-frequency');
                  if (freqEl) {
                      freqEl.textContent = `${metrics.recent_trades_count}/${metrics.max_trades_per_hour}`;
                      const limitEl = document.getElementById('frequency-limit');
                      if (limitEl) {
                          limitEl.textContent = `${metrics.trades_remaining_this_hour} remaining this hour`;
                          limitEl.className = metrics.trades_remaining_this_hour > 0 
                              ? 'text-xs text-green-400 mt-1' 
                              : 'text-xs text-red-400 mt-1';
                      }
                  }
                  
                  // Update daily P&L
                  const pnlEl = document.getElementById('daily-pnl');
                  if (pnlEl) {
                      const pnl = metrics.daily_return_percent || 0;
                      pnlEl.textContent = `${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}%`;
                      pnlEl.className = pnl >= 0 ? 'text-2xl font-bold text-green-400' : 'text-2xl font-bold text-red-400';
                  }
                  
                  const lossCapEl = document.getElementById('daily-loss-cap');
                  if (lossCapEl) {
                      lossCapEl.textContent = `Loss Cap: ${(metrics.daily_loss_cap * 100).toFixed(1)}%`;
                      const remaining = metrics.daily_loss_cap_remaining || 0;
                      lossCapEl.className = remaining > 0 
                          ? 'text-xs text-green-400 mt-1' 
                          : 'text-xs text-red-400 mt-1';
                  }
                  
                  // Update uncertainty (placeholder - would come from model)
                  const uncEl = document.getElementById('uncertainty-metric');
                  if (uncEl) {
                      uncEl.textContent = 'N/A'; // Would be populated from model
                  }
              }
          } catch (error) {
              console.error('Error fetching RL risk metrics:', error);
              // Hide section on error
              const section = document.getElementById('rl-risk-section');
              if (section) {
                  section.style.display = 'none';
              }
          }
      }
      
      // Load risk metrics on page load
      updateRLRisk();
      
      // Refresh risk metrics every minute
      setInterval(updateRLRisk, 60 * 1000);

      // RL Agent Discovered Rules
      async function updateDiscoveredRules() {
          try {
              const response = await fetch('/api/rl-agent/rules?limit=10');
              const data = await response.json();
              
              if (data.success && data.rules) {
                  const tbody = document.getElementById('rules-tbody');
                  if (!tbody) return;
                  
                  if (data.rules.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">No rules discovered yet</td></tr>';
                      return;
                  }
                  
                  let html = '';
                  data.rules.forEach(rule => {
                      const winRateColor = rule.win_rate >= 0.6 ? 'text-green-400' : 
                                          rule.win_rate >= 0.5 ? 'text-yellow-400' : 'text-red-400';
                      
                      html += `
                        <tr class="border-b border-gray-700 hover:bg-gray-700/30">
                          <td class="py-3 px-4 text-gray-300 text-xs">${rule.rule_text || 'N/A'}</td>
                          <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded text-xs ${
                              rule.action === 'BUY' ? 'bg-green-500/20 text-green-400' :
                              rule.action === 'SELL' ? 'bg-red-500/20 text-red-400' :
                              'bg-yellow-500/20 text-yellow-400'
                            }">${rule.action}</span>
                          </td>
                          <td class="py-3 px-4 text-right ${winRateColor} font-bold">${(rule.win_rate * 100).toFixed(1)}%</td>
                          <td class="py-3 px-4 text-right text-gray-300">${rule.avg_return_1h !== null ? (rule.avg_return_1h * 100).toFixed(2) + '%' : 'N/A'}</td>
                          <td class="py-3 px-4 text-right text-gray-300">${rule.avg_return_24h !== null ? (rule.avg_return_24h * 100).toFixed(2) + '%' : 'N/A'}</td>
                          <td class="py-3 px-4 text-right text-gray-400">${rule.sample_size || 0}</td>
                        </tr>
                      `;
                  });
                  
                  tbody.innerHTML = html;
              }
          } catch (error) {
              console.error('Error fetching discovered rules:', error);
          }
      }
      
      async function updateFeatureImportance() {
          try {
              const response = await fetch('/api/rl-agent/feature-importance');
              const data = await response.json();
              
              if (data.success && data.feature_importance) {
                  const container = document.getElementById('feature-importance');
                  if (!container) return;
                  
                  // Sort by importance
                  const features = Object.entries(data.feature_importance)
                      .sort((a, b) => b[1] - a[1]);
                  
                  let html = '';
                  features.forEach(([feature, importance]) => {
                      const percentage = (importance * 100).toFixed(1);
                      html += `
                        <div class="flex items-center justify-between bg-gray-700/50 rounded p-2">
                          <span class="text-sm text-gray-300">${feature.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                          <div class="flex items-center space-x-2">
                            <div class="w-32 bg-gray-600 rounded-full h-2">
                              <div class="bg-purple-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-sm text-white font-medium w-12 text-right">${percentage}%</span>
                          </div>
                        </div>
                      `;
                  });
                  
                  container.innerHTML = html || '<div class="text-gray-400 text-sm">No feature importance data available</div>';
              }
          } catch (error) {
              console.error('Error fetching feature importance:', error);
          }
      }
      
      // Load rules and feature importance on page load
      updateDiscoveredRules();
      updateFeatureImportance();
      
      // Refresh every 10 minutes
      setInterval(() => {
          updateDiscoveredRules();
          updateFeatureImportance();
      }, 10 * 60 * 1000);
  </script>
</body>
</html>
